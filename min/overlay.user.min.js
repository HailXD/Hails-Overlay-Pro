(()=>{let w=1e3,M=1e3,T=3,a=window.fetch,t=(e,t)=>{try{if("undefined"!=typeof GM&&"function"==typeof GM.getValue)return GM.getValue(e,t);if("function"==typeof GM_getValue)return Promise.resolve(GM_getValue(e,t))}catch{}return Promise.resolve(t)},l=(e,t)=>{try{if("undefined"!=typeof GM&&"function"==typeof GM.setValue)return GM.setValue(e,t);if("function"==typeof GM_setValue)return Promise.resolve(GM_setValue(e,t))}catch{}return Promise.resolve()};function n(o){return new Promise((e,t)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t,a.readAsDataURL(o)})}async function j(e){o=e;var o,e=await new Promise((t,a)=>{try{GM_xmlhttpRequest({method:"GET",url:o,responseType:"blob",onload:e=>{200<=e.status&&e.status<300&&e.response?t(e.response):a(new Error(`GM_xhr failed: ${e.status} `+e.statusText))},onerror:()=>a(new Error("GM_xhr network error")),ontimeout:()=>a(new Error("GM_xhr timeout"))})}catch(e){a(e)}});if(e&&String(e.type).startsWith("image/"))return n(e);throw new Error("URL did not return an image blob")}let p=[[0,0,0],[60,60,60],[120,120,120],[210,210,210],[255,255,255],[96,0,24],[237,28,36],[255,127,39],[246,170,9],[249,221,59],[255,250,188],[14,185,104],[19,230,123],[135,255,94],[12,129,110],[16,174,166],[19,225,190],[96,247,242],[40,80,158],[64,147,228],[107,80,246],[153,177,251],[120,12,153],[170,56,185],[224,159,249],[203,0,122],[236,31,128],[243,141,169],[104,70,52],[149,104,42],[248,178,119]],m=[[170,170,170],[165,14,30],[250,128,114],[228,92,26],[156,132,49],[197,173,49],[232,212,95],[74,107,58],[90,148,74],[132,197,115],[15,121,159],[187,250,242],[125,199,255],[77,49,184],[74,66,132],[122,113,196],[181,174,241],[155,82,73],[209,128,120],[250,182,164],[219,164,99],[123,99,82],[156,132,107],[214,181,148],[209,128,81],[255,197,165],[109,100,63],[148,140,107],[205,197,158],[51,57,65],[109,117,141],[179,185,209]],h={"0,0,0":"Black","60,60,60":"Dark Gray","120,120,120":"Gray","210,210,210":"Light Gray","255,255,255":"White","96,0,24":"Deep Red","237,28,36":"Red","255,127,39":"Orange","246,170,9":"Gold","249,221,59":"Yellow","255,250,188":"Light Yellow","14,185,104":"Dark Green","19,230,123":"Green","135,255,94":"Light Green","12,129,110":"Dark Teal","16,174,166":"Teal","19,225,190":"Light Teal","96,247,242":"Cyan","40,80,158":"Dark Blue","64,147,228":"Blue","107,80,246":"Indigo","153,177,251":"Light Indigo","120,12,153":"Dark Purple","170,56,185":"Purple","224,159,249":"Light Purple","203,0,122":"Dark Pink","236,31,128":"Pink","243,141,169":"Light Pink","104,70,52":"Dark Brown","149,104,42":"Brown","248,178,119":"Beige","170,170,170":"Medium Gray","165,14,30":"Dark Red","250,128,114":"Light Red","228,92,26":"Dark Orange","156,132,49":"Dark Goldenrod","197,173,49":"Goldenrod","232,212,95":"Light Goldenrod","74,107,58":"Dark Olive","90,148,74":"Olive","132,197,115":"Light Olive","15,121,159":"Dark Cyan","187,250,242":"Light Cyan","125,199,255":"Light Blue","77,49,184":"Dark Indigo","74,66,132":"Dark Slate Blue","122,113,196":"Slate Blue","181,174,241":"Light Slate Blue","155,82,73":"Dark Peach","209,128,120":"Peach","250,182,164":"Light Peach","219,164,99":"Light Brown","123,99,82":"Dark Tan","156,132,107":"Tan","214,181,148":"Light Tan","209,128,81":"Dark Beige","255,197,165":"Light Beige","109,100,63":"Dark Stone","148,140,107":"Stone","205,197,158":"Light Stone","51,57,65":"Dark Slate","109,117,141":"Slate","179,185,209":"Light Slate"},o=p.map(([e,t,a])=>e+`,${t},`+a),s=[];class e extends Map{constructor(e){super(),this.limit=e}set(e,t){var a;return this.size>=this.limit&&(a=this.keys().next().value,this.delete(a)),super.set(e,t)}}let d=unsafeWindow;function K(){return Date.now().toString(36)+"-"+Math.random().toString(36).slice(2,10)}function G(e){var t=new Set(F.overlays.map(e=>(e.name||"").toLowerCase()));if(!t.has(e.toLowerCase()))return e;let a=1;for(;t.has(`${e} (${a})`.toLowerCase());)a++;return`${e} (${a})`}function L(e,t){var a;return"undefined"!=typeof OffscreenCanvas?new OffscreenCanvas(e,t):((a=document.createElement("canvas")).width=e,a.height=t,a)}function _(e,t){var a=document.createElement("canvas");return a.width=e,a.height=t,a}function y(e){return e.convertToBlob?e.convertToBlob():new Promise((t,a)=>e.toBlob(e=>e?t(e):a(new Error("toBlob failed")),"image/png"))}async function Z(e){if(e&&"function"==typeof e.toDataURL)return e.toDataURL("image/png");if(e&&"function"==typeof e.convertToBlob)return n(await e.convertToBlob());if("undefined"!=typeof OffscreenCanvas&&e instanceof OffscreenCanvas){var t=e.transferToImageBitmap?.();if(t)return(e=_(e.width,e.height)).getContext("2d").drawImage(t,0,0),e.toDataURL("image/png")}throw new Error("Cannot export canvas to data URL")}async function x(r){if("function"==typeof createImageBitmap)try{return await createImageBitmap(r)}catch{}return new Promise((e,t)=>{let a=URL.createObjectURL(r),o=new Image;o.onload=()=>{URL.revokeObjectURL(a),e(o)},o.onerror=e=>{URL.revokeObjectURL(a),t(e)},o.src=a})}async function V(e){if(!e.imageBase64)return null;if(null==e.visibleColorKeys)return E(e.imageBase64);var t=e.visibleColorKeys.slice().sort().join(","),t=e.imageBase64.slice(0,64)+":"+e.imageBase64.length+"|"+t;if(c.has(t))return c.get(t);var a,o=await E(e.imageBase64),r=o.width,i=o.height,l=L(r,i),n=l.getContext("2d",{willReadFrequently:!0}),o=(n.drawImage(o,0,0),n.getImageData(0,0,r,i)),s=o.data,d=new Set(e.visibleColorKeys);for(let e=0;e<s.length;e+=4)0<s[e+3]&&(a=`${s[e]},${s[e+1]},`+s[e+2],d.has(a)||(s[e+3]=0));n.putImageData(o,0,0);r=await("function"==typeof createImageBitmap?createImageBitmap(l):E(await Z(l)));return c.set(t,r),r}function E(o){return r.has(o)?Promise.resolve(r.get(o)):new Promise((e,t)=>{let a=new Image;a.crossOrigin="anonymous",a.onload=()=>{r.set(o,a),e(a)},a.onerror=t,a.src=o})}function k(e){try{var t=new URL(e),a=t.pathname.split("/"),o=new URLSearchParams(t.search);return{chunk1:parseInt(a[3],10),chunk2:parseInt(a[4],10),posX:parseInt(o.get("x")||"0",10),posY:parseInt(o.get("y")||"0",10)}}catch{return{chunk1:0,chunk2:0,posX:0,posY:0}}}function J(e,t,a,o,r,i,l,n){var s=Math.max(e,r),d=Math.max(t,i),e=Math.min(e+a,r+l),a=Math.min(t+o,i+n);return{x:s,y:d,w:Math.max(0,e-s),h:Math.max(0,a-d)}}let C=new e(50),S=new Set,r=new e(50),c=new e(50),I=new e(200),$=new e(200);function Q(e){return[e.imageBase64?e.imageBase64.slice(0,64)+":"+e.imageBase64.length:"none",e.pixelUrl||"null",e.offsetX,e.offsetY,e.opacity].join("|")}function R(){C.clear(),r.clear(),c.clear(),I.clear(),$.clear()}function B(e,t=3e3){let a=document.getElementById("op-toast-stack"),o=(a||((a=document.createElement("div")).className="op-toast-stack",a.id="op-toast-stack",document.body.appendChild(a)),a.classList.toggle("op-dark","dark"===F.theme),document.createElement("div"));o.className="op-toast",o.textContent=e,a.appendChild(o),requestAnimationFrame(()=>o.classList.add("show")),setTimeout(()=>{o.classList.remove("show"),setTimeout(()=>o.remove(),200)},t)}let i=!1;function P(){if(e=F.overlays.some(e=>e.enabled&&e.imageBase64),t=!!F.autoCapturePixelUrl&&!!F.activeOverlayId,("behind"===F.overlayMode||"above"===F.overlayMode||"smart"===F.overlayMode||"diff"===F.overlayMode||"minify"===F.overlayMode)&&(e||t)&&0<F.overlays.length){if(!i){let b=a;e=async(t,a)=>{var e,o,r,i,l="string"==typeof t?t:t&&t.url||"",n=(F.autoCapturePixelUrl&&F.activeOverlayId&&(o=(e=>{try{var t,a,o=new URL(e,location.href);return"backend.wplace.live"!==o.hostname?null:(t=o.pathname.match(/\/s0\/pixel\/(\d+)\/(\d+)$/))?(a=o.searchParams,{normalized:`https://backend.wplace.live/s0/pixel/${t[1]}/${t[2]}?x=${a.get("x")||0}&y=`+(a.get("y")||0)}):null}catch{return null}})(l))&&(e=F.overlays.find(e=>e.id===F.activeOverlayId))&&e.pixelUrl!==o.normalized&&(e.pixelUrl=o.normalized,e.offsetX=0,e.offsetY=0,await O(["overlays"]),R(),F.autoCapturePixelUrl=!1,await O(["autoCapturePixelUrl"]),D(),o=k(e.pixelUrl),B(`Anchor set for "${e.name}": chunk ${o.chunk1}/${o.chunk2} at (${o.posX}, ${o.posY}). Offset reset to (0,0).`),P()),(e=>{try{var t,a=new URL(e,location.href);return"backend.wplace.live"===a.hostname&&a.pathname.startsWith("/files/")?(t=a.pathname.match(/\/(\d+)\/(\d+)\.png$/i))?{chunk1:parseInt(t[1],10),chunk2:parseInt(t[2],10)}:null:null}catch{return null}})(l));if(!n||!["behind","above","smart","diff","minify"].includes(F.overlayMode))return b(t,a);try{var s=await b(t,a);if(!s.ok)return s;if(!(s.headers.get("Content-Type")||"").toLowerCase().includes("image"))return s;var d=F.overlays.filter(e=>e.enabled&&e.imageBase64&&e.pixelUrl);if(0===d.length)return s;var p=await s.blob();try{r=p.slice(),(i=L((r=await x(r)).width,r.height).getContext("2d")).drawImage(r,0,0);var c=await i.getImageData(0,0,r.width,r.height),u=n.chunk1+","+n.chunk2;I.set(u,c),z()}catch(e){console.error("Hail's OP: Failed to cache tile",e)}if(15728640<p.size)return s;let e;if("minify"===F.overlayMode){var v,g=[];for(v of d)g.push(await(async(e,t,a)=>{if(!e.enabled||!e.imageBase64||!e.pixelUrl)return null;if(S.has(e.id))return null;var o=T,r=Q(e),r=e.id+`|${r}|minify|s${o}|${t}|`+a;if(C.has(r))return C.get(r);var i=await V(e);if(!i)return null;var l=i.width,n=i.height;if(l>=M||n>=M)return S.add(e.id),B(`Overlay "${e.name}" skipped: image too large (must be smaller than ${M}×${M}; got ${l}×${n}).`),null;var s=k(e.pixelUrl);if(!Number.isFinite(s.chunk1)||!Number.isFinite(s.chunk2))return null;var t=s.chunk1*w+s.posX+e.offsetX-t*w,s=s.chunk2*w+s.posY+e.offsetY-a*w,a=w*o,d=w*o,t=Math.round(t*o),s=Math.round(s*o),p=l*o,c=n*o,u=J(0,0,a,d,t,s,p,c);if(0===u.w||0===u.h)return C.set(r,null),null;var v,g,m=L(a,d).getContext("2d",{willReadFrequently:!0}),h=(m.imageSmoothingEnabled=!1,m.clearRect(0,0,a,d),m.drawImage(i,0,0,l,n,t,s,p,c),(a=m.getImageData(u.x,u.y,u.w,u.h)).data),f=e.opacity,b=255*(1-f),y=Math.floor(o/2),x=u.w;for(let e=0;e<h.length;e+=4)0!==h[e+3]&&(v=e/4%x,g=Math.floor(e/4/x),v=u.x+v,g=u.y+g,v%o===y&&g%o===y?(F.highlightPixels?(h[e]=255,h[e+1]=0,h[e+2]=255):(h[e]=Math.round(h[e]*f+b),h[e+1]=Math.round(h[e+1]*f+b),h[e+2]=Math.round(h[e+2]*f+b)),h[e+3]=255):(h[e]=0,h[e+1]=0,h[e+2]=0,h[e+3]=0));return d={imageData:a,dx:u.x,dy:u.y,scaled:!0,scale:o},C.set(r,d),d})(v,n.chunk1,n.chunk2));e=await(async(e,t)=>{if(!t||0===t.length)return e;var a,o,r,i=T,l=(e=await x(e)).width,n=e.height,s=L(l*i,n*i),d=s.getContext("2d",{willReadFrequently:!0});d.imageSmoothingEnabled=!1,d.drawImage(e,0,0,l*i,n*i);for(a of t)a&&(r=a.imageData.width,o=a.imageData.height,0!==r)&&0!==o&&((r=L(r,o)).getContext("2d",{willReadFrequently:!0}).putImageData(a.imageData,0,0),d.drawImage(r,a.dx,a.dy));return y(s)})(p,g.filter(Boolean))}else{var m,h=[];for(m of d)h.push(await(async(e,t,a)=>{if(!e.enabled||!e.imageBase64||!e.pixelUrl)return null;if(S.has(e.id))return null;var o=Q(e),o=e.id+`|${o}|${t}|`+a;if(C.has(o))return C.get(o);if(!(n=await V(e)))return null;var r=n.width,i=n.height;if(r>=M||i>=M)return S.add(e.id),B(`Overlay "${e.name}" skipped: image too large (must be smaller than ${M}×${M}; got ${r}×${i}).`),null;var l=k(e.pixelUrl);if(!Number.isFinite(l.chunk1)||!Number.isFinite(l.chunk2))return null;if(t=l.chunk1*w+l.posX+e.offsetX-t*w,l=l.chunk2*w+l.posY+e.offsetY-a*w,0===(a=J(0,0,w,w,t,l,r,i)).w||0===a.h)return C.set(o,null),null;(r=L(w,w).getContext("2d",{willReadFrequently:!0})).drawImage(n,t,l);var i=r.getImageData(a.x,a.y,a.w,a.h),n="smart"===F.overlayMode||"diff"===F.overlayMode?new Uint8ClampedArray(i.data):null,s=i.data,d=e.opacity,p=255*(1-d);for(let e=0;e<s.length;e+=4)0<s[e+3]&&(F.highlightPixels?(s[e]=255,s[e+1]=0,s[e+2]=255):(s[e]=Math.round(s[e]*d+p),s[e+1]=Math.round(s[e+1]*d+p),s[e+2]=Math.round(s[e+2]*d+p)),s[e+3]=255);return t={imageData:i,dx:a.x,dy:a.y,rawData:n},C.set(o,t),t})(m,n.chunk1,n.chunk2));e="smart"===F.overlayMode?await(async(e,t)=>{if(!t||0===t.length)return e;var a,o=(e=await x(e)).width,r=e.height,i=L(o,r),l=i.getContext("2d",{willReadFrequently:!0}),n=(l.drawImage(e,0,0),(e=l.getImageData(0,0,o,r)).data),s=new Uint32Array(n.buffer);for(a of t)if(a&&a.rawData){var d=a.rawData,p=a.imageData.data,c=a.imageData.width,u=a.imageData.height,v=new Uint32Array(d.buffer),g=new Uint32Array(p.buffer);for(let t=0;t<u;t++){var m=a.dy+t;if(!(m<0||r<=m))for(let e=0;e<c;e++){var h,f=a.dx+e;f<0||o<=f||0<d[3+4*(t*c+e)]&&(f=m*o+f,v[h=t*c+e]!==s[f])&&(s[f]=g[h])}}}return l.putImageData(e,0,0),y(i)})(p,h.filter(Boolean)):"diff"===F.overlayMode?await(async(e,t)=>{if(!t||0===t.length)return e;var a,o=(e=await x(e)).width,r=e.height,i=L(o,r),l=i.getContext("2d",{willReadFrequently:!0}),n=(l.drawImage(e,0,0),(e=l.getImageData(0,0,o,r)).data),s=new Uint32Array(n.buffer);for(a of t)if(a&&a.rawData){var d=a.rawData,p=a.imageData.data,c=a.imageData.width,u=a.imageData.height,v=new Uint32Array(d.buffer),g=new Uint32Array(p.buffer);for(let t=0;t<u;t++){var m=a.dy+t;if(!(m<0||r<=m))for(let e=0;e<c;e++){var h,f=a.dx+e;f<0||o<=f||0<d[3+4*(t*c+e)]&&(f=m*o+f,h=t*c+e,0<n[4*f+3])&&v[h]!==s[f]&&(s[f]=g[h])}}}return l.putImageData(e,0,0),y(i)})(p,h.filter(Boolean)):await("behind"===F.overlayMode?async(e,t)=>{if(!t||0===t.length)return e;var a,o=L((e=await x(e)).width,e.height),r=o.getContext("2d");for(a of t)a&&r.putImageData(a.imageData,a.dx,a.dy);return r.drawImage(e,0,0),y(o)}:async(e,t)=>{if(!t||0===t.length)return e;var a,o,r=L((e=await x(e)).width,e.height),i=r.getContext("2d");i.drawImage(e,0,0);for(a of t)a&&a.imageData&&0!==a.imageData.width&&0!==a.imageData.height&&((o=L(a.imageData.width,a.imageData.height)).getContext("2d").putImageData(a.imageData,0,0),i.drawImage(o,a.dx,a.dy));return y(r)})(p,h.filter(Boolean))}var f=new Headers(s.headers);return f.set("Content-Type","image/png"),f.delete("Content-Length"),new Response(e,{status:s.status,statusText:s.statusText,headers:f})}catch(e){return console.error("Hail's OP: Error processing tile",e),b(t,a)}};d.fetch=e,window.fetch=e,i=!0}}else i&&(d.fetch=a,window.fetch=a,i=!1);var e,t}let F={overlays:[],activeOverlayId:null,overlayMode:"behind",isPanelCollapsed:!1,autoCapturePixelUrl:!1,panelX:null,panelY:null,theme:"light",collapseList:!1,collapseEditor:!1,collapseNudge:!1,collapseColors:!1,highlightPixels:!1,ccFreeKeys:o.slice(),ccPaidKeys:s.slice(),ccZoom:1,ccRealtime:!1},u=Object.keys(F);async function O(e=u){try{await Promise.all(e.map(e=>l(e,F[e])))}catch(e){console.error("Hail's OP: Failed to save config",e)}}function v(){if(!document.getElementById("overlay-pro-panel")){var e,a,o,r,i,l,n,t=document.createElement("div"),u=(t.id="overlay-pro-panel",Math.max(12,window.innerWidth-340-80));t.style.left=(Number.isFinite(F.panelX)?F.panelX:u)+"px",t.style.top=(Number.isFinite(F.panelY)?F.panelY:120)+"px",t.innerHTML=`
      <div class="op-header" id="op-header">
          <h3>Hail's OP</h3>
          <div class="op-header-actions">
              <button class="op-hdr-btn" id="op-theme-toggle" title="Toggle theme">☀️/🌙</button>
              <button class="op-hdr-btn" id="op-refresh-btn" title="Refresh">⟲</button>
              <button class="op-toggle-btn" id="op-panel-toggle" title="Collapse">▾</button>
          </div>
      </div>
      <div class="op-content" id="op-content">
          <div class="op-column">
              <div class="op-section">
                  <div class="op-row space">
                      <select class="op-select" id="op-mode-select" style="flex: 1;">
                          <option value="behind" style="color: cyan;">Overlay Behind</option>
                          <option value="above">Overlay Above</option>
                          <option value="smart">Smart</option>
                          <option value="diff" style="color: red;">Diff</option>
                          <option value="minify">Minified</option>
                          <option value="original">Original</option>
                      </select>
                      <div class="op-row">
                          <span class="op-muted" id="op-place-label">Place overlay:</span>
                          <button class="op-button" id="op-autocap-toggle" title="Capture next clicked pixel as anchor">OFF</button>
                      </div>
                  </div>
                  <div class="op-row" style="padding: 4px 0;">
                      <input type="checkbox" id="op-highlight-toggle" style="margin-left: 4px;">
                      <label for="op-highlight-toggle" style="cursor:pointer;">Highlight pixels (pink)</label>
                  </div>
              </div>
              <div class="op-section">
                  <div class="op-section-title">
                      <div class="op-title-left">
                          <span class="op-title-text">Overlays</span>
                      </div>
                      <div class="op-title-right">
                          <div class="op-row">
                              <button class="op-button" id="op-add-overlay" title="Create a new overlay">+ Add</button>
                              <button class="op-button" id="op-import-overlay" title="Import overlay JSON">Import</button>
                              <button class="op-button" id="op-export-overlay" title="Export active overlay JSON">Export</button>
                              <button class="op-chevron" id="op-collapse-list" title="Collapse/Expand">▾</button>
                          </div>
                      </div>
                  </div>
                  <div id="op-list-wrap">
                      <div class="op-list" id="op-overlay-list"></div>
                  </div>
              </div>
              <div class="op-section" id="op-editor-section">
                  <div class="op-section-title">
                      <div class="op-title-left">
                          <span class="op-title-text">Editor</span>
                      </div>
                      <div class="op-title-right">
                          <button class="op-chevron" id="op-collapse-editor" title="Collapse/Expand">▾</button>
                      </div>
                  </div>
                  <div id="op-editor-body">
                      <div class="op-row">
                          <label style="width: 90px;">Name</label>
                          <input type="text" class="op-input op-grow" id="op-name">
                      </div>
                      <div id="op-image-source">
                          <div class="op-row">
                              <label style="width: 90px;">Image</label>
                              <input type="text" class="op-input op-grow" id="op-image-url" placeholder="Paste a direct image link">
                              <button class="op-button" id="op-fetch">Fetch</button>
                          </div>
                          <div class="op-preview" id="op-dropzone">
                              <div class="op-drop-hint">Drop here or click to browse.</div>
                              <input type="file" id="op-file-input" accept="image/*" style="display:none">
                          </div>
                      </div>
                      <div class="op-preview" id="op-preview-wrap" style="display:none;">
                          <img id="op-image-preview" alt="No image">
                      </div>
                      <div class="op-row" id="op-cc-btn-row" style="display:none; justify-content:space-between; gap:8px; flex-wrap:wrap;">
                          <button class="op-button" id="op-download-overlay" title="Download this overlay image">Download</button>
                          <button class="op-button" id="op-open-resize" title="Resize the overlay image">Resize</button>
                          <button class="op-button" id="op-open-cc" title="Match colors to Wplace palette">Color Match</button>
                      </div>
                      <div class="op-row"><span class="op-muted" id="op-coord-display"></span></div>
                      <div class="op-row" style="width: 100%; gap: 12px; padding: 6px 0;">
                          <label style="width: 60px;">Opacity</label>
                          <input type="range" min="0" max="1" step="0.05" class="op-slider op-grow" id="op-opacity-slider">
                          <span id="op-opacity-value" style="width: 36px; text-align: right;">70%</span>
                      </div>
                  </div>
              </div>
              <div class="op-section" id="op-nudge-section">
                  <div class="op-section-title">
                      <div class="op-title-left">
                          <span class="op-title-text">Nudge overlay</span>
                      </div>
                      <div class="op-title-right">
                          <span class="op-muted" id="op-offset-indicator">Offset X 0, Y 0</span>
                          <button class="op-chevron" id="op-collapse-nudge" title="Collapse/Expand">▾</button>
                      </div>
                  </div>
                  <div id="op-nudge-body">
                      <div class="op-nudge-row" style="text-align: right;">
                          <button class="op-icon-btn" id="op-nudge-left" title="Left">←</button>
                          <button class="op-icon-btn" id="op-nudge-down" title="Down">↓</button>
                          <button class="op-icon-btn" id="op-nudge-up" title="Up">↑</button>
                          <button class="op-icon-btn" id="op-nudge-right" title="Right">→</button>
                      </div>
                  </div>
              </div>
          </div>
          <div class="op-column">
              <div class="op-section" id="op-colors-section" style="flex-grow: 1;">
                  <div class="op-section-title">
                      <div class="op-title-left">
                          <span class="op-title-text">Color Toggle</span>
                      </div>
                      <div class="op-title-right">
                           <button class="op-button" id="op-colors-refresh" title="Refresh counts" style="padding: 2px 6px; font-size: 12px;">Refresh</button>
                          <button class="op-chevron" id="op-collapse-colors" title="Collapse/Expand">▾</button>
                      </div>
                  </div>
                  <div id="op-colors-body">
                      <div class="op-row" style="gap: 6px; flex-wrap: wrap;">
                          <button class="op-button" id="op-colors-all">All</button>
                          <button class="op-button" id="op-colors-none">None</button>
                          <button class="op-button" id="op-colors-free">All Free</button>
                          <button class="op-button" id="op-colors-paid">All Paid</button>
                          <button class="op-button" id="op-colors-copy">Copy</button>
                      </div>
                      <div class="op-list" id="op-colors-list" style="max-height: 480px; gap: 4px;"></div>
                  </div>
              </div>
          </div>
      </div>
    `,document.body.appendChild(t),(u=document.createElement("div")).className="op-cc-backdrop",u.id="op-cc-backdrop",document.body.appendChild(u),(g=document.createElement("div")).className="op-cc-modal",g.id="op-cc-modal",g.style.display="none",g.innerHTML=`
      <div class="op-cc-header" id="op-cc-header">
        <div class="op-cc-title">Color Match</div>
        <div class="op-row" style="gap:6px;">
          <button class="op-button op-cc-pill" id="op-cc-realtime">Realtime: OFF</button>
          <button class="op-cc-close" id="op-cc-close" title="Close">✕</button>
        </div>
      </div>

      <div class="op-cc-body">
        <div class="op-cc-preview-wrap" style="grid-area: preview;">
          <canvas id="op-cc-preview" class="op-cc-canvas"></canvas>
          <div class="op-cc-zoom">
            <button class="op-icon-btn" id="op-cc-zoom-out" title="Zoom out">−</button>
            <button class="op-icon-btn" id="op-cc-zoom-in" title="Zoom in">+</button>
          </div>
        </div>

        <div class="op-cc-controls" style="grid-area: controls;">
          <div class="op-cc-palette" id="op-cc-free">
            <div class="op-row space">
              <label>Free Colors</label>
              <button class="op-button" id="op-cc-free-toggle">Unselect All</button>
            </div>
            <div id="op-cc-free-grid" class="op-cc-grid"></div>
          </div>

          <div class="op-cc-palette" id="op-cc-paid">
            <div class="op-row space">
              <label>Paid Colors (2000💧each)</label>
              <button class="op-button" id="op-cc-paid-toggle">Select All</button>
            </div>
            <div id="op-cc-paid-grid" class="op-cc-grid"></div>
          </div>

          <div class="op-cc-block">
            <label>Color Counts</label>
            <div id="op-cc-color-list" class="op-list op-list-subtle" style="max-height: 160px;"></div>
          </div>
        </div>
      </div>

      <div class="op-cc-footer">
        <div class="op-cc-ghost" id="op-cc-meta"></div>
        <div class="op-cc-actions">
          <button class="op-button" id="op-cc-recalc" title="Recalculate color mapping">Calculate</button>
          <button class="op-button" id="op-cc-apply" title="Apply changes to overlay">Apply</button>
          <button class="op-button" id="op-cc-cancel" title="Close without saving">Cancel</button>
        </div>
      </div>
    `,document.body.appendChild(g),g.querySelector("#op-cc-close").addEventListener("click",Y),u.addEventListener("click",Y),g.querySelector("#op-cc-cancel").addEventListener("click",Y),(q={backdrop:u,modal:g,previewCanvas:g.querySelector("#op-cc-preview"),previewCtx:g.querySelector("#op-cc-preview").getContext("2d",{willReadFrequently:!0}),sourceCanvas:null,sourceCtx:null,sourceImageData:null,processedCanvas:null,processedCtx:null,freeGrid:g.querySelector("#op-cc-free-grid"),paidGrid:g.querySelector("#op-cc-paid-grid"),freeToggle:g.querySelector("#op-cc-free-toggle"),paidToggle:g.querySelector("#op-cc-paid-toggle"),meta:g.querySelector("#op-cc-meta"),applyBtn:g.querySelector("#op-cc-apply"),recalcBtn:g.querySelector("#op-cc-recalc"),realtimeBtn:g.querySelector("#op-cc-realtime"),zoom:1,selectedFree:new Set(F.ccFreeKeys),selectedPaid:new Set(F.ccPaidKeys),realtime:!!F.ccRealtime,overlay:null,lastColorCounts:{},isStale:!1}).realtimeBtn.addEventListener("click",async()=>{q.realtime=!q.realtime,q.realtimeBtn.textContent="Realtime: "+(q.realtime?"ON":"OFF"),q.realtimeBtn.classList.toggle("op-danger",q.realtime),F.ccRealtime=q.realtime,await O(["ccRealtime"]),q.realtime&&q.isStale&&d()}),u=async()=>{q.zoom=Math.min(8,1.25*(q.zoom||1)),F.ccZoom=q.zoom,await O(["ccZoom"]),X(),A()},e=async()=>{q.zoom=Math.max(.1,(q.zoom||1)/1.25),F.ccZoom=q.zoom,await O(["ccZoom"]),X(),A()},g.querySelector("#op-cc-zoom-in").addEventListener("click",u),g.querySelector("#op-cc-zoom-out").addEventListener("click",e),q.recalcBtn.addEventListener("click",()=>{d()}),q.applyBtn.addEventListener("click",async()=>{var e,t=q.overlay;t&&(0===re().length?B("Select at least one color."):(q.isStale&&d(),q.processedCanvas?q.processedCanvas.width>=M||q.processedCanvas.height>=M?B(`Image too large to apply (must be < ${M}×${M}).`):(e=q.processedCanvas.toDataURL("image/png"),t.imageBase64=e,t.imageUrl=null,t.isLocal=!0,await O(["overlays"]),R(),P(),D(),e=Object.keys(q.lastColorCounts).length,B(`Overlay updated (${q.processedCanvas.width}×${q.processedCanvas.height}, ${e} colors).`),Y()):B("Nothing to apply.")))}),q.freeGrid.innerHTML="",q.paidGrid.innerHTML="";for([a,o,r]of p){let e=`${a},${o},`+r,t=document.createElement("div");t.className="op-cc-cell",t.style.background=`rgb(${a},${o},${r})`,t.title=h[e]||e,t.dataset.key=e,t.dataset.type="free",q.selectedFree.has(e)&&t.classList.add("active"),t.addEventListener("click",async()=>{q.selectedFree.has(e)?q.selectedFree.delete(e):q.selectedFree.add(e),t.classList.toggle("active",q.selectedFree.has(e)),F.ccFreeKeys=Array.from(q.selectedFree),await O(["ccFreeKeys"]),q.realtime?U():q.isStale=!0,X(),A(),W()}),q.freeGrid.appendChild(t)}for([i,l,n]of m){let e=`${i},${l},`+n,t=document.createElement("div");t.className="op-cc-cell",t.style.background=`rgb(${i},${l},${n})`,t.title=h[e]||e,t.dataset.key=e,t.dataset.type="paid",q.selectedPaid.has(e)&&t.classList.add("active"),t.addEventListener("click",async()=>{q.selectedPaid.has(e)?q.selectedPaid.delete(e):q.selectedPaid.add(e),t.classList.toggle("active",q.selectedPaid.has(e)),F.ccPaidKeys=Array.from(q.selectedPaid),await O(["ccPaidKeys"]),q.realtime?U():q.isStale=!0,X(),A(),W()}),q.paidGrid.appendChild(t)}W(),q.freeToggle.addEventListener("click",async()=>{se("free",!le()),F.ccFreeKeys=Array.from(q.selectedFree),await O(["ccFreeKeys"]),(q.realtime?d:s)(),X(),A(),W()}),q.paidToggle.addEventListener("click",async()=>{se("paid",!ne()),F.ccPaidKeys=Array.from(q.selectedPaid),await O(["ccPaidKeys"]),(q.realtime?d:s)(),X(),A(),W()});{let e=document.createElement("div"),t=(e.className="op-rs-backdrop",e.id="op-rs-backdrop",document.body.appendChild(e),document.createElement("div")),a=(t.className="op-rs-modal",t.id="op-rs-modal",t.style.display="none",t.innerHTML=`
      <div class="op-rs-header" id="op-rs-header">
        <div class="op-rs-title">Resize Overlay</div>
        <button class="op-rs-close" id="op-rs-close" title="Close">✕</button>
      </div>

      <div class="op-rs-tabs">
        <button class="op-rs-tab-btn active" id="op-rs-tab-simple">Simple</button>
        <button class="op-rs-tab-btn" id="op-rs-tab-advanced">Advanced (grid)</button>
      </div>

      <div class="op-rs-body">
        <div class="op-rs-pane show" id="op-rs-pane-simple">
          <div class="op-rs-row">
            <label style="width:110px;">Original</label>
            <input type="text" class="op-input" id="op-rs-orig" disabled>
          </div>
          <div class="op-rs-row">
            <label style="width:110px;">Width</label>
            <input type="number" min="1" step="1" class="op-input" id="op-rs-w">
          </div>
          <div class="op-rs-row">
            <label style="width:110px;">Height</label>
            <input type="number" min="1" step="1" class="op-input" id="op-rs-h">
          </div>
          <div class="op-rs-row">
            <input type="checkbox" id="op-rs-lock" checked>
            <label for="op-rs-lock">Lock aspect ratio</label>
          </div>
          <div class="op-rs-row" style="gap:6px; flex-wrap:wrap;">
            <label style="width:110px;">Quick</label>
            <button class="op-button" id="op-rs-double">2x</button>
            <button class="op-button" id="op-rs-onex">1x</button>
            <button class="op-button" id="op-rs-half">0.5x</button>
            <button class="op-button" id="op-rs-third">0.33x</button>
            <button class="op-button" id="op-rs-quarter">0.25x</button>
          </div>
          <div class="op-rs-row">
            <label style="width:110px;">Scale factor</label>
            <input type="number" step="0.01" min="0.01" class="op-input" id="op-rs-scale" placeholder="e.g. 0.5">
            <button class="op-button" id="op-rs-apply-scale">Apply</button>
          </div>

          <div class="op-rs-preview-wrap" id="op-rs-sim-wrap">
            <div class="op-rs-dual">
              <div class="op-rs-col" id="op-rs-col-left">
                <div class="label">Original</div>
                <div class="pad-top"></div>
                <canvas id="op-rs-sim-orig" class="op-rs-canvas op-rs-thumb"></canvas>
              </div>
              <div class="op-rs-col" id="op-rs-col-right">
                <div class="label">Result (downscale → upscale preview)</div>
                <div class="pad-top"></div>
                <canvas id="op-rs-sim-new" class="op-rs-canvas op-rs-thumb"></canvas>
              </div>
            </div>
          </div>
        </div>

        <div class="op-rs-pane" id="op-rs-pane-advanced">
          <div class="op-rs-preview-wrap op-pan-grab" id="op-rs-adv-wrap">
            <canvas id="op-rs-preview" class="op-rs-canvas"></canvas>
            <div class="op-rs-zoom">
              <button class="op-icon-btn" id="op-rs-zoom-out" title="Zoom out">−</button>
              <button class="op-icon-btn" id="op-rs-zoom-in" title="Zoom in">+</button>
            </div>
          </div>

          <div class="op-rs-row" style="margin-top:8px;">
            <label style="width:160px;">Multiplier</label>
            <input type="range" id="op-rs-mult-range" min="1" max="64" step="0.1" style="flex:1;">
            <input type="number" id="op-rs-mult-input" class="op-input op-rs-mini" min="1" step="0.05">
          </div>

          <div class="op-rs-row">
            <input type="checkbox" id="op-rs-bind" checked>
            <label for="op-rs-bind">Bind X/Y block sizes</label>
          </div>

          <div class="op-rs-row">
            <label style="width:160px;">Block W / H</label>
            <input type="number" id="op-rs-blockw" class="op-input op-rs-mini" min="1" step="0.1">
            <input type="number" id="op-rs-blockh" class="op-input op-rs-mini" min="1" step="0.1">
          </div>

          <div class="op-rs-row">
            <label style="width:160px;">Offset X / Y</label>
            <input type="number" id="op-rs-offx" class="op-input op-rs-mini" min="0" step="0.1">
            <input type="number" id="op-rs-offy" class="op-input op-rs-mini" min="0" step="0.1">
          </div>

          <div class="op-rs-row">
            <label style="width:160px;">Dot radius</label>
            <input type="range" id="op-rs-dotr" min="1" max="8" step="1" style="flex:1;">
            <span id="op-rs-dotr-val" class="op-muted" style="width:36px; text-align:right;"></span>
          </div>

          <div class="op-rs-row">
            <input type="checkbox" id="op-rs-grid" checked>
            <label for="op-rs-grid">Show grid wireframe</label>
          </div>

          <div class="op-rs-grid-note" id="op-rs-adv-note">Align red dots to block centers. Drag to pan; use buttons or Ctrl+wheel to zoom.</div>

          <div class="op-rs-row" style="margin-top:8px;">
            <label style="width:160px;">Calculated preview</label>
            <span class="op-muted" id="op-rs-adv-resmeta"></span>
          </div>
          <div class="op-rs-preview-wrap" id="op-rs-adv-result-wrap" style="height: clamp(200px, 26vh, 420px);">
            <canvas id="op-rs-adv-result" class="op-rs-canvas"></canvas>
          </div>
        </div>
      </div>

      <div class="op-rs-footer">
        <div class="op-cc-ghost" id="op-rs-meta">Nearest-neighbor OR grid center sampling; alpha hardened (no semi-transparent pixels).</div>
        <div class="op-cc-actions">
          <button class="op-button" id="op-rs-calc">Calculate</button>
          <button class="op-button" id="op-rs-apply">Apply</button>
          <button class="op-button" id="op-rs-cancel">Cancel</button>
        </div>
      </div>
    `,document.body.appendChild(t),{backdrop:e,modal:t,tabSimple:t.querySelector("#op-rs-tab-simple"),tabAdvanced:t.querySelector("#op-rs-tab-advanced"),paneSimple:t.querySelector("#op-rs-pane-simple"),paneAdvanced:t.querySelector("#op-rs-pane-advanced"),orig:t.querySelector("#op-rs-orig"),w:t.querySelector("#op-rs-w"),h:t.querySelector("#op-rs-h"),lock:t.querySelector("#op-rs-lock"),note:t.querySelector("#op-rs-note"),onex:t.querySelector("#op-rs-onex"),half:t.querySelector("#op-rs-half"),third:t.querySelector("#op-rs-third"),quarter:t.querySelector("#op-rs-quarter"),double:t.querySelector("#op-rs-double"),scale:t.querySelector("#op-rs-scale"),applyScale:t.querySelector("#op-rs-apply-scale"),simWrap:t.querySelector("#op-rs-sim-wrap"),simOrig:t.querySelector("#op-rs-sim-orig"),simNew:t.querySelector("#op-rs-sim-new"),colLeft:t.querySelector("#op-rs-col-left"),colRight:t.querySelector("#op-rs-col-right"),advWrap:t.querySelector("#op-rs-adv-wrap"),preview:t.querySelector("#op-rs-preview"),meta:t.querySelector("#op-rs-meta"),zoomIn:t.querySelector("#op-rs-zoom-in"),zoomOut:t.querySelector("#op-rs-zoom-out"),multRange:t.querySelector("#op-rs-mult-range"),multInput:t.querySelector("#op-rs-mult-input"),bind:t.querySelector("#op-rs-bind"),blockW:t.querySelector("#op-rs-blockw"),blockH:t.querySelector("#op-rs-blockh"),offX:t.querySelector("#op-rs-offx"),offY:t.querySelector("#op-rs-offy"),dotR:t.querySelector("#op-rs-dotr"),dotRVal:t.querySelector("#op-rs-dotr-val"),gridToggle:t.querySelector("#op-rs-grid"),advNote:t.querySelector("#op-rs-adv-note"),resWrap:t.querySelector("#op-rs-adv-result-wrap"),resCanvas:t.querySelector("#op-rs-adv-result"),resMeta:t.querySelector("#op-rs-adv-resmeta"),calcBtn:t.querySelector("#op-rs-calc"),applyBtn:t.querySelector("#op-rs-apply"),cancelBtn:t.querySelector("#op-rs-cancel"),closeBtn:t.querySelector("#op-rs-close")}),w=a.preview.getContext("2d",{willReadFrequently:!0}),u=a.simOrig.getContext("2d",{willReadFrequently:!0}),v=a.simNew.getContext("2d",{willReadFrequently:!0}),i=a.resCanvas.getContext("2d",{willReadFrequently:!0}),o=(H={...a,ov:null,img:null,origW:0,origH:0,mode:"simple",zoom:1,updating:!1,mult:4,gapX:4,gapY:4,offx:0,offy:0,dotr:1,viewX:0,viewY:0,panning:!1,panStart:null,calcCanvas:null,calcCols:0,calcRows:0,calcReady:!1},()=>{var e=parseInt(H.w.value||"0",10),t=parseInt(H.h.value||"0",10),a=Number.isFinite(e)&&Number.isFinite(t)&&0<e&&0<t,o=e>=M||t>=M;return a?o?`Target: ${e}×${t} (exceeds limit: must be < ${M}×${M})`:`Target: ${e}×${t} (OK)`:"Enter positive width and height."}),r=()=>{var e=Math.floor((H.origW-H.offx)/H.gapX),t=Math.floor((H.origH-H.offy)/H.gapY);return{cols:Math.max(0,e),rows:Math.max(0,t)}},l=()=>{var{cols:e,rows:t}=r(),a=e>=M||t>=M;return 0<e&&0<t?`Samples: ${e} × ${t} | Output: ${e}×`+t+(a?` (exceeds limit: < ${M}×${M})`:""):"Adjust multiplier/offset until dots sit at centers."},n=()=>{H.meta.textContent=("advanced"===H.mode?l:o)()},s=()=>{var e=parseInt(H.w.value||"0",10),t=parseInt(H.h.value||"0",10),a=Number.isFinite(e)&&Number.isFinite(t)&&0<e&&0<t,o=e>=M||t>=M,e=a?o?`Target: ${e}×${t} (exceeds limit: must be < ${M}×${M})`:`Target: ${e}×${t} (OK)`:"Enter positive width and height.";H.note&&(H.note.textContent=e),"simple"===H.mode&&(H.applyBtn.disabled=!a||o),"simple"===H.mode&&(H.meta.textContent=e)};function b(e){var t=Math.max(1,Math.round(H.origW*e)),e=Math.max(1,Math.round(H.origH*e));H.updating=!0,H.w.value=t,H.h.value=H.lock.checked?Math.max(1,Math.round(t*H.origH/H.origW)):e,H.updating=!1,s()}function y(){if(H.img){var e=H.colLeft.querySelector(".pad-top").offsetHeight,t=H.colRight.querySelector(".pad-top").offsetHeight,a=H.colLeft.clientWidth,o=H.colRight.clientWidth,e=H.colLeft.clientHeight-e,t=H.colRight.clientHeight-t,r=(H.simOrig.width=a,H.simOrig.height=e,H.simNew.width=o,H.simNew.height=t,u.save(),u.imageSmoothingEnabled=!1,u.clearRect(0,0,a,e),Math.min(a/H.origW,e/H.origH)),i=Math.max(1,Math.floor(H.origW*r)),r=Math.max(1,Math.floor(H.origH*r)),a=Math.floor((a-i)/2),e=Math.floor((e-r)/2),l=(u.drawImage(H.img,0,0,H.origW,H.origH,a,e,i,r),u.restore(),parseInt(H.w.value||"0",10)),n=parseInt(H.h.value||"0",10);if(v.save(),v.imageSmoothingEnabled=!1,v.clearRect(0,0,o,t),Number.isFinite(l)&&Number.isFinite(n)&&0<l&&0<n){var s=L(l,n),d=s.getContext("2d",{willReadFrequently:!0}),p=(d.imageSmoothingEnabled=!1,d.clearRect(0,0,l,n),d.drawImage(H.img,0,0,H.origW,H.origH,0,0,l,n),d.getImageData(0,0,l,n)),c=p.data;for(let e=0;e<c.length;e+=4)0!==c[e+3]&&(c[e+3]=255);d.putImageData(p,0,0);d=Math.min(o/l,t/n),p=Math.max(1,Math.floor(l*d)),d=Math.max(1,Math.floor(n*d)),o=Math.floor((o-p)/2),t=Math.floor((t-d)/2);v.drawImage(s,0,0,l,n,o,t,p,d)}else v.drawImage(H.img,0,0,H.origW,H.origH,a,e,i,r);v.restore()}}let d=()=>{H.updating=!0,H.multRange.value=String(H.mult),H.multInput.value=String(H.mult),H.blockW.value=String(H.gapX),H.blockH.value=String(H.gapY),H.offX.value=String(H.offx),H.offY.value=String(H.offy),H.dotR.value=String(H.dotr),H.dotRVal.textContent=String(H.dotr),H.updating=!1};function x(){var e,t=r().cols;t>=M||M;"advanced"===H.mode?H.applyBtn.disabled=!H.calcReady:(t=parseInt(H.w.value||"0",10),e=parseInt(H.h.value||"0",10),t=Number.isFinite(t)&&Number.isFinite(e)&&0<t&&0<e&&t<M&&e<M,H.applyBtn.disabled=!t),n()}function k(){if("advanced"===H.mode&&H.img){var t=H.origW,a=H.origH,o=Math.max(50,Math.floor(H.advWrap.clientWidth)),r=Math.max(50,Math.floor(H.advWrap.clientHeight)),e=(H.preview.width=o,H.preview.height=r,Math.max(1,Math.floor(o/H.zoom))),i=Math.max(1,Math.floor(r/H.zoom)),t=Math.max(0,t-e),a=Math.max(0,a-i);if(H.viewX=Math.min(Math.max(0,H.viewX),t),H.viewY=Math.min(Math.max(0,H.viewY),a),w.save(),w.imageSmoothingEnabled=!1,w.clearRect(0,0,o,r),w.drawImage(H.img,H.viewX,H.viewY,e,i,0,0,o,r),H.gridToggle.checked&&1<=H.gapX&&1<=H.gapY){w.strokeStyle="rgba(255,59,48,0.45)",w.lineWidth=1;var t=Math.ceil((H.viewX-H.offx)/H.gapX),l=Math.floor((H.viewX+e-H.offx)/H.gapX),a=Math.ceil((H.viewY-H.offy)/H.gapY),n=Math.floor((H.viewY+i-H.offy)/H.gapY),s=Math.max(0,l-t+1),d=Math.max(0,n-a+1);if(s<=4e3&&d<=4e3){w.beginPath();for(let e=t;e<=l;e++){var p=H.offx+e*H.gapX,p=Math.round((p-H.viewX)*H.zoom);w.moveTo(p+.5,0),w.lineTo(p+.5,r)}for(let e=a;e<=n;e++){var c=H.offy+e*H.gapY,c=Math.round((c-H.viewY)*H.zoom);w.moveTo(0,c+.5),w.lineTo(o,c+.5)}w.stroke()}}if(1<=H.gapX&&1<=H.gapY){w.fillStyle="#ff3b30";var u=H.offx+Math.floor(H.gapX/2),v=H.offy+Math.floor(H.gapY/2);if(0<=u&&0<=v){var g=Math.ceil((H.viewX-u)/H.gapX),s=Math.ceil((H.viewY-v)/H.gapY),m=Math.floor((H.viewY+i-1-v)/H.gapY),h=Math.floor((H.viewX+e-1-u)/H.gapX),f=H.dotr;if(Math.max(0,h-g+1)*Math.max(0,m-s+1)<=3e5)for(let e=s;e<=m;e++){var b=v+e*H.gapY;for(let e=g;e<=h;e++){var y=u+e*H.gapX,y=Math.round((y-H.viewX)*H.zoom),x=Math.round((b-H.viewY)*H.zoom);w.beginPath(),w.arc(y,x,f,0,2*Math.PI),w.fill()}}}}w.restore()}}function C(){var e,t,a,o=H.calcCanvas,r=H.resWrap;r&&o?(e=o.width,t=o.height,a=Math.max(50,Math.floor(r.clientWidth-16)),r=Math.max(50,Math.floor(r.clientHeight-16)),a=Math.min(a/e,r/t),r=Math.max(1,Math.floor(e*a)),a=Math.max(1,Math.floor(t*a)),H.resCanvas.width=r,H.resCanvas.height=a,i.save(),i.imageSmoothingEnabled=!1,i.clearRect(0,0,r,a),i.drawImage(o,0,0,e,t,0,0,r,a),i.restore(),H.resMeta.textContent=`Output: ${e}×`+t+(e>=M||t>=M?` (exceeds limit: < ${M}×${M})`:"")):(i.clearRect(0,0,H.resCanvas.width,H.resCanvas.height),H.resMeta.textContent="No result. Click Calculate.")}H._drawSimplePreview=y,H._drawAdvancedPreview=k,H._drawAdvancedResultPreview=C;let p=e=>{H.mode=e,H.tabSimple.classList.toggle("active","simple"===e),H.tabAdvanced.classList.toggle("active","advanced"===e),H.paneSimple.classList.toggle("show","simple"===e),H.paneAdvanced.classList.toggle("show","advanced"===e),n(),H.calcBtn.style.display="advanced"===e?"inline-block":"none","advanced"===e?H.applyBtn.disabled=!H.calcReady:s(),x(),("advanced"===e?(k(),C):y)()},c=(H.tabSimple.addEventListener("click",()=>p("simple")),H.tabAdvanced.addEventListener("click",()=>p("advanced")),H.w.addEventListener("input",()=>{var e;H.updating||(H.updating=!0,e=parseInt(H.w.value||"0",10),H.lock.checked&&0<H.origW&&0<H.origH&&0<e&&(H.h.value=Math.max(1,Math.round(e*H.origH/H.origW))),H.updating=!1,s(),"simple"===H.mode&&y())}),H.h.addEventListener("input",()=>{var e;H.updating||(H.updating=!0,e=parseInt(H.h.value||"0",10),H.lock.checked&&0<H.origW&&0<H.origH&&0<e&&(H.w.value=Math.max(1,Math.round(e*H.origW/H.origH))),H.updating=!1,s(),"simple"===H.mode&&y())}),H.onex.addEventListener("click",()=>{b(1),y()}),H.half.addEventListener("click",()=>{b(.5),y()}),H.third.addEventListener("click",()=>{b(1/3),y()}),H.quarter.addEventListener("click",()=>{b(.25),y()}),H.double.addEventListener("click",()=>{b(2),y()}),H.applyScale.addEventListener("click",()=>{var e=parseFloat(H.scale.value||"");!Number.isFinite(e)||e<=0?B("Enter a valid scale factor > 0"):(b(e),y())}),()=>{"advanced"===H.mode&&(H.calcReady=!1,H.applyBtn.disabled=!0,C(),n())}),g=e=>{H.updating||(e=parseFloat(e),Number.isFinite(e)&&(e=Math.min(Math.max(e,1),128),H.mult=e,H.bind.checked&&(H.gapX=e,H.gapY=e),d(),x(),k(),c()))},m=(H.multRange.addEventListener("input",e=>{H.updating||g(e.target.value)}),H.multInput.addEventListener("input",e=>{H.updating||(e=e.target.value,Number.isFinite(parseFloat(e))&&g(e))}),H.bind.addEventListener("change",()=>{H.bind.checked&&(H.gapX=H.mult,H.gapY=H.mult,d()),x(),k(),c()}),H.blockW.addEventListener("input",e=>{H.updating||(e=e.target.value,e=parseFloat(e),Number.isFinite(e)&&(H.gapX=Math.min(Math.max(e,1),4096),H.bind.checked&&(H.mult=H.gapX,H.gapY=H.gapX),d(),x(),k(),c()))}),H.blockH.addEventListener("input",e=>{H.updating||(e=e.target.value,e=parseFloat(e),Number.isFinite(e)&&(H.gapY=Math.min(Math.max(e,1),4096),H.bind.checked&&(H.mult=H.gapY,H.gapX=H.gapY),d(),x(),k(),c()))}),H.offX.addEventListener("input",e=>{e=e.target.value,e=parseFloat(e);Number.isFinite(e)&&(H.offx=Math.min(Math.max(e,0),Math.max(0,H.origH-1e-4)),H.viewX=Math.min(H.viewX,Math.max(0,H.origW-1)),x(),k(),c())}),H.offY.addEventListener("input",e=>{e=e.target.value,e=parseFloat(e);Number.isFinite(e)&&(H.offy=Math.min(Math.max(e,0),Math.max(0,H.origH-1e-4)),H.viewY=Math.min(H.viewY,Math.max(0,H.origH-1)),x(),k(),c())}),H.dotR.addEventListener("input",e=>{H.dotr=Math.max(1,Math.round(Number(e.target.value)||1)),H.dotRVal.textContent=String(H.dotr),k()}),H.gridToggle.addEventListener("change",k),e=>{var t=Math.max(50,Math.floor(H.advWrap.clientWidth)),a=Math.max(50,Math.floor(H.advWrap.clientHeight)),o=Math.max(1,Math.floor(t/H.zoom)),r=Math.max(1,Math.floor(a/H.zoom)),o=H.viewX+o/2,r=H.viewY+r/2,e=(H.zoom=Math.min(32,Math.max(.1,H.zoom*e)),Math.max(1,Math.floor(t/H.zoom))),t=Math.max(1,Math.floor(a/H.zoom));H.viewX=Math.min(Math.max(0,Math.round(o-e/2)),Math.max(0,H.origW-e)),H.viewY=Math.min(Math.max(0,Math.round(r-t/2)),Math.max(0,H.origH-t)),k()}),h=(H.zoomIn.addEventListener("click",()=>m(1.25)),H.zoomOut.addEventListener("click",()=>m(.8)),H.advWrap.addEventListener("wheel",e=>{e.ctrlKey&&(e.preventDefault(),e=e.deltaY||0,m(0<e?1/1.15:1.15))},{passive:!1}),e=>{H.panning&&(H.panning=!1,H.panStart=null,H.advWrap.classList.remove("op-pan-grabbing"),H.advWrap.classList.add("op-pan-grab"),H.advWrap.releasePointerCapture?.(e.pointerId))}),f=(H.advWrap.addEventListener("pointerdown",e=>{e.target.closest(".op-rs-zoom")||(H.panning=!0,H.panStart={x:e.clientX,y:e.clientY,viewX:H.viewX,viewY:H.viewY},H.advWrap.classList.remove("op-pan-grab"),H.advWrap.classList.add("op-pan-grabbing"),H.advWrap.setPointerCapture?.(e.pointerId))}),H.advWrap.addEventListener("pointermove",e=>{var t,a,o;H.panning&&(o=e.clientX-H.panStart.x,e=e.clientY-H.panStart.y,t=H.advWrap.clientWidth,a=H.advWrap.clientHeight,t=Math.max(1,Math.floor(t/H.zoom)),a=Math.max(1,Math.floor(a/H.zoom)),o=H.panStart.viewX-Math.round(o/H.zoom),e=H.panStart.viewY-Math.round(e/H.zoom),o=Math.min(Math.max(0,o),Math.max(0,H.origW-t)),e=Math.min(Math.max(0,e),Math.max(0,H.origH-a)),H.viewX=o,H.viewY=e,k())}),H.advWrap.addEventListener("pointerup",h),H.advWrap.addEventListener("pointercancel",h),H.advWrap.addEventListener("pointerleave",h),()=>de());H.cancelBtn.addEventListener("click",f),H.closeBtn.addEventListener("click",f),e.addEventListener("click",f),H.calcBtn.addEventListener("click",async()=>{if("advanced"===H.mode)try{var e,{cols:t,rows:a}=r();t<=0||a<=0?B("No samples. Adjust multiplier/offset."):t>=M||a>=M?B(`Output too large. Must be < ${M}×${M}.`):(e=await(async(e,a,o,t,r,i,l)=>{var n=L(a,o),s=((n=n.getContext("2d",{willReadFrequently:!0})).imageSmoothingEnabled=!1,n.drawImage(e,0,0),n.getImageData(0,0,a,o).data),d=Math.floor((a-t)/i),p=Math.floor((o-r)/l);if(d<=0||p<=0)throw new Error("No samples available with current offset/gap");var e=_(d,p),c=(n=e.getContext("2d")).createImageData(d,p),u=c.data,v=t+i/2,g=r+l/2,m=(e,t,a)=>Math.min(Math.max(e,t),a);for(let t=0;t<p;t++)for(let e=0;e<d;e++){var h=Math.round(m(v+e*i,0,a-1)),h=4*(Math.round(m(g+t*l,0,o-1))*a+h),f=s[h],b=s[1+h],y=s[2+h],h=s[3+h],x=4*(t*d+e);0===h?(u[x]=0,u[1+x]=0,u[2+x]=0,u[3+x]=0):(u[x]=f,u[1+x]=b,u[2+x]=y,u[3+x]=255)}return n.putImageData(c,0,0),e})(H.img,H.origW,H.origH,H.offx,H.offy,H.gapX,H.gapY),H.calcCanvas=e,H.calcCols=t,H.calcRows=a,H.calcReady=!0,H.applyBtn.disabled=!1,C(),n(),B(`Calculated ${t}×${a}. Review preview, then Apply.`))}catch(e){console.error(e),B("Calculation failed.")}}),H.applyBtn.addEventListener("click",async()=>{if(H.ov)try{if("simple"===H.mode){var e=parseInt(H.w.value||"0",10),t=parseInt(H.h.value||"0",10);if(!Number.isFinite(e)||!Number.isFinite(t)||e<=0||t<=0)B("Invalid dimensions");else if(e>=M||t>=M)B(`Too large. Must be < ${M}×${M}.`);else{var a=H.ov,o=e,r=t,i=await E(a.imageBase64),l=_(o,r),n=l.getContext("2d",{willReadFrequently:!0}),s=(n.imageSmoothingEnabled=!1,n.clearRect(0,0,o,r),n.drawImage(i,0,0,i.width,i.height,0,0,o,r),(i=n.getImageData(0,0,o,r)).data);for(let e=3;e<s.length;e+=4)0<s[e]&&(s[e]=255);n.putImageData(i,0,0),o=l.toDataURL("image/png"),a.imageBase64=o,a.imageUrl=null,a.isLocal=!0,await O(["overlays"]),R(),P(),D(),await 0,de(),B(`Resized to ${e}×${t}.`)}}else{var d;H.calcReady&&H.calcCanvas?(d=await Z(H.calcCanvas),H.ov.imageBase64=d,H.ov.imageUrl=null,H.ov.isLocal=!0,await O(["overlays"]),R(),P(),D(),de(),B(`Applied ${H.calcCols}×${H.calcRows}.`)):B("Calculate first.")}}catch(e){console.error(e),B("Apply failed.")}}),H._syncAdvancedMeta=x,H._syncSimpleNote=s,H._setMode=e=>{var t=new Event("click");("simple"===e?H.tabSimple:H.tabAdvanced).dispatchEvent(t)}}{let i=e=>document.getElementById(e),a=(i("op-theme-toggle").addEventListener("click",async e=>{e.stopPropagation(),F.theme="light"===F.theme?"dark":"light",await O(["theme"]),oe()}),i("op-refresh-btn").addEventListener("click",e=>{e.stopPropagation(),location.reload()}),i("op-mode-select").addEventListener("change",e=>{F.overlayMode=e.target.value,O(["overlayMode"]),P(),D()}),i("op-autocap-toggle").addEventListener("click",()=>{F.autoCapturePixelUrl=!F.autoCapturePixelUrl,O(["autoCapturePixelUrl"]),P(),D()}),i("op-highlight-toggle").addEventListener("change",async e=>{F.highlightPixels=e.target.checked,await O(["highlightPixels"]),R()}),i("op-add-overlay").addEventListener("click",async()=>{try{e=G("Overlay"),e={id:K(),name:e,enabled:!0,imageUrl:null,imageBase64:null,isLocal:!1,pixelUrl:null,offsetX:0,offsetY:0,opacity:.7,visibleColorKeys:[]},F.overlays.push(e),F.activeOverlayId=e.id,await O(["overlays","activeOverlayId"]),R(),P(),D(),await e}catch(e){console.error(e)}var e}),i("op-import-overlay").addEventListener("click",async()=>{var r=prompt("Paste overlay JSON (single or array):");if(r){let e;try{e=JSON.parse(r)}catch{return void await void alert("Invalid JSON")}let t=Array.isArray(e)?e:[e],a=0,o=0;for(var i of t){var l=G(i.name||"Imported Overlay"),n=i.imageUrl,s=i.pixelUrl??null,d=Number.isFinite(i.offsetX)?i.offsetX:0,p=Number.isFinite(i.offsetY)?i.offsetY:0,i=Number.isFinite(i.opacity)?i.opacity:.7;if(n)try{var c=await j(n),u={id:K(),name:l,enabled:!0,imageUrl:n,imageBase64:c,isLocal:!1,pixelUrl:s,offsetX:d,offsetY:p,opacity:i,visibleColorKeys:[]};F.overlays.push(u),a++}catch(e){console.error("Import failed for",n,e),o++}else o++}0<a&&(F.activeOverlayId=F.overlays[F.overlays.length-1].id,await O(["overlays","activeOverlayId"]),R(),P(),D()),alert("Import finished. Imported: "+a+(o?", Failed: "+o:""));void await 0}}),i("op-export-overlay").addEventListener("click",()=>{var t=f();if(t)if(t.isLocal||!t.imageUrl)alert("This overlay uses a local image and cannot be exported. Please host the image and set an image URL.");else{let e=JSON.stringify({version:1,name:t.name,imageUrl:t.imageUrl,pixelUrl:t.pixelUrl??null,offsetX:t.offsetX,offsetY:t.offsetY,opacity:t.opacity},null,2);ae(e).then(()=>alert("Overlay JSON copied to clipboard!")).catch(()=>{prompt("Copy the JSON below:",e)})}else alert("No active overlay selected.")}),i("op-collapse-list").addEventListener("click",()=>{F.collapseList=!F.collapseList,O(["collapseList"]),D()}),i("op-collapse-editor").addEventListener("click",()=>{F.collapseEditor=!F.collapseEditor,O(["collapseEditor"]),D()}),i("op-collapse-nudge").addEventListener("click",()=>{F.collapseNudge=!F.collapseNudge,O(["collapseNudge"]),D()}),i("op-collapse-colors").addEventListener("click",()=>{F.collapseColors=!F.collapseColors,O(["collapseColors"]),D()}),i("op-colors-refresh").addEventListener("click",async()=>{$.clear(),await z()}),i("op-colors-all").addEventListener("click",async()=>{var e=f();e&&(e.visibleColorKeys=null,await O(["overlays"]),R(),await z())}),i("op-colors-none").addEventListener("click",async()=>{var e=f();e&&(e.visibleColorKeys=[],await O(["overlays"]),R(),await z())}),i("op-colors-free").addEventListener("click",async()=>{var e=f();if(e){var a=await N(e),a=Object.keys(a);let t=new Set(p.map(([e,t,a])=>e+`,${t},`+a));e.visibleColorKeys=a.filter(e=>t.has(e)),await O(["overlays"]),R(),await z()}}),i("op-colors-paid").addEventListener("click",async()=>{var e=f();if(e){var a=await N(e),a=Object.keys(a);let t=new Set(m.map(([e,t,a])=>e+`,${t},`+a));e.visibleColorKeys=a.filter(e=>t.has(e)),await O(["overlays"]),R(),await z()}}),i("op-colors-copy").addEventListener("click",async()=>{var e=f();if(e){var t=await N(e);let o=new Set(m.map(([e,t,a])=>e+`,${t},`+a));var a=Object.entries(t).sort(([,e],[,t])=>t-e);let n;n=null==e.visibleColorKeys?new Set(Object.keys(t)):new Set(e.visibleColorKeys);t=a.map(([e,t])=>{var a=o.has(e);return{key:e,name:h[e]||e,premiumStatus:a?"PAID":"FREE",count:t.toString()}});if(0===t.length)ae("```\n```").then(()=>B("No color data to copy.")).catch(()=>B("Failed to copy."));else{let r=Math.max(...t.map(e=>e.name.length)),i=Math.max(...t.map(e=>e.premiumStatus.length)),l=Math.max(...t.map(e=>e.count.length));ae("```\n"+t.map(({key:e,name:t,premiumStatus:a,count:o})=>`- [${n.has(e)?"x":" "}] ${t.padEnd(r," ")};${a.padEnd(i," ")};${o.padEnd(l," ")};`).join("\n")+"\n```").then(()=>B("Color data copied to clipboard!")).catch(()=>B("Failed to copy color data."))}}}),i("op-name").addEventListener("change",async e=>{let a=f();if(a){let t=(e.target.value||"").trim()||"Overlay";F.overlays.some(e=>e.id!==a.id&&(e.name||"").toLowerCase()===t.toLowerCase())?(a.name=G(t),B(`Name in use. Renamed to "${a.name}".`)):a.name=t,await O(["overlays"]),ee()}}),i("op-fetch").addEventListener("click",async()=>{var e=f();if(e)if(e.imageBase64)alert("This overlay already has an image. Create a new overlay to change the image.");else{var t,a,o,r=i("op-image-url").value.trim();if(r)try{t=e,o=await j(a=r),t.imageUrl=a,t.imageBase64=o,t.isLocal=!1,await O(["overlays"]),R(),F.autoCapturePixelUrl=!0,await O(["autoCapturePixelUrl"]),P(),D(),B("Image loaded. Placement mode ON -- click once to set anchor.")}catch(e){console.error(e),alert("Failed to fetch image.")}else alert("Enter an image link first.")}else alert("No active overlay selected.")}),i("op-dropzone")),e=(a.addEventListener("click",()=>i("op-file-input").click()),i("op-file-input").addEventListener("change",async e=>{var t=e.target.files&&e.target.files[0];if(e.target.value="",t){e=f();if(e)if(e.imageBase64)alert("This overlay already has an image. Create a new overlay to change the image.");else try{await te(e,t)}catch(e){console.error(e),alert("Failed to load local image.")}}}),["dragenter","dragover"].forEach(e=>a.addEventListener(e,e=>{e.preventDefault(),e.stopPropagation(),a.classList.add("drop-highlight")})),["dragleave","drop"].forEach(t=>a.addEventListener(t,e=>{e.preventDefault(),e.stopPropagation(),"dragleave"===t&&e.target!==a||a.classList.remove("drop-highlight")})),a.addEventListener("drop",async e=>{e=e.dataTransfer;if(e){e=e.files&&e.files[0];if(e){var t=f();if(t)if(t.imageBase64)alert("This overlay already has an image. Create a new overlay to change the image.");else try{await te(t,e)}catch(e){console.error(e),alert("Failed to load dropped image.")}}}}),async(e,t)=>{var a=f();a&&(a.offsetX+=e,a.offsetY+=t,await O(["overlays"]),R(),D())}),t=(i("op-nudge-up").addEventListener("click",()=>e(0,-1)),i("op-nudge-down").addEventListener("click",()=>e(0,1)),i("op-nudge-left").addEventListener("click",()=>e(-1,0)),i("op-nudge-right").addEventListener("click",()=>e(1,0)),i("op-opacity-slider").addEventListener("input",e=>{var t=f();t&&(t.opacity=parseFloat(e.target.value),document.getElementById("op-opacity-value").textContent=Math.round(100*t.opacity)+"%")}),i("op-opacity-slider").addEventListener("change",async()=>{await O(["overlays"]),R()}),i("op-download-overlay").addEventListener("click",()=>{var e,t=f();t&&t.imageBase64?((e=document.createElement("a")).href=t.imageBase64,e.download=(t.name||"overlay").replace(/[^\w.-]+/g,"_")+".png",document.body.appendChild(e),e.click(),e.remove()):B("No overlay image to download.")}),i("op-open-cc").addEventListener("click",()=>{var t=f();if(t&&t.imageBase64){if(q){q.overlay=t,document.body.classList.add("op-scroll-lock"),q.zoom=Number(F.ccZoom)||1,q.realtime=!!F.ccRealtime,q.realtimeBtn.textContent="Realtime: "+(q.realtime?"ON":"OFF"),q.realtimeBtn.classList.toggle("op-danger",q.realtime);let e=new Image;e.onload=()=>{q.sourceCanvas||(q.sourceCanvas=document.createElement("canvas"),q.sourceCtx=q.sourceCanvas.getContext("2d",{willReadFrequently:!0})),q.sourceCanvas.width=e.width,q.sourceCanvas.height=e.height,q.sourceCtx.clearRect(0,0,e.width,e.height),q.sourceCtx.drawImage(e,0,0),q.sourceImageData=q.sourceCtx.getImageData(0,0,e.width,e.height),q.processedCanvas||(q.processedCanvas=document.createElement("canvas"),q.processedCtx=q.processedCanvas.getContext("2d")),U(),q.isStale=!1,X(),A(),ie(),q.backdrop.classList.add("show"),q.modal.style.display="flex"},e.src=t.imageBase64}}else B("No overlay image to edit.")}),i("op-open-resize"));t&&t.addEventListener("click",()=>{var e=f();if(e&&e.imageBase64){if(H){H.ov=e;let r=new Image;r.onload=()=>{H.img=r,H.origW=r.width,H.origH=r.height,H.orig.value=H.origW+"×"+H.origH,H.w.value=String(H.origW),H.h.value=String(H.origH),H.lock.checked=!0,H.zoom=1,H.mult=4,H.gapX=4,H.gapY=4,H.offx=0,H.offy=0,H.dotr=1,H.viewX=0,H.viewY=0,H.bind.checked=!0,H.multRange.value="4",H.multInput.value="4",H.blockW.value="4",H.blockH.value="4",H.offX.value="0",H.offY.value="0",H.dotR.value="1",H.dotRVal.textContent="1",H.gridToggle.checked=!0,H.calcCanvas=null,H.calcCols=0,H.calcRows=0,H.calcReady=!1,H.applyBtn.disabled="advanced"===H.mode,H._setMode("simple"),document.body.classList.add("op-scroll-lock"),H.backdrop.classList.add("show"),H.modal.style.display="flex",H._drawSimplePreview?.(),H._drawAdvancedPreview?.(),H._drawAdvancedResultPreview?.(),H._syncAdvancedMeta?.(),H._syncSimpleNote?.();"advanced"===H.mode?({cols:t,rows:a}=(t=Math.floor((H.origW-H.offx)/H.gapX),a=Math.floor((H.origH-H.offy)/H.gapY),{cols:Math.max(0,t),rows:Math.max(0,a)}),H.meta.textContent=0<t&&0<a?`Samples: ${t} × ${a} | Output: ${t}×`+a+(t>=M||a>=M?` (exceeds limit: < ${M}×${M})`:""):"Adjust multiplier/offset until dots sit at centers."):(t=parseInt(H.w.value||"0",10),a=parseInt(H.h.value||"0",10),o=Number.isFinite(t)&&Number.isFinite(a)&&0<t&&0<a,e=t>=M||a>=M,H.meta.textContent=o?e?`Target: ${t}×${a} (exceeds limit: must be < ${M}×${M})`:`Target: ${t}×${a} (OK)`:"Enter positive width and height.");var e,t,a,o=()=>{"simple"===H.mode?H._drawSimplePreview?.():(H._drawAdvancedPreview?.(),H._drawAdvancedResultPreview?.())};H._resizeHandler=o,window.addEventListener("resize",o)},r.src=e.imageBase64}}else B("No overlay image to resize.")}),window.addEventListener("resize",()=>{})}{var v=t;let o=v.querySelector("#op-header"),c=v.querySelector("#op-panel-toggle");if(o&&c){let r=!1,i=0,l=0,n=0,s=0,d=!1,p=(e,t,a)=>Math.min(Math.max(e,t),a);var u=e=>{var t,a,o;r&&(t=e.clientX-i,e=e.clientY-l,a=Math.max(8,window.innerWidth-v.offsetWidth-8),o=Math.max(8,window.innerHeight-v.offsetHeight-8),v.style.left=p(n+t,8,a)+"px",v.style.top=p(s+e,8,o)+"px",d=!0)},g=e=>{var t;r&&(t=v.classList.contains("collapsed")?c:o,r=!1,t.releasePointerCapture?.(e.pointerId),d)&&(F.panelX=parseInt(v.style.left,10)||0,F.panelY=parseInt(v.style.top,10)||0,O(["panelX","panelY"]))};v.addEventListener("pointerdown",e=>{var t=v.classList.contains("collapsed"),a=t?c:o;if(t){if(e.target!==c)return}else if(!e.target.closest("#op-header")||e.target.closest("button"))return;r=!0,d=!1,i=e.clientX,l=e.clientY;t=v.getBoundingClientRect();n=t.left,s=t.top,a.setPointerCapture?.(e.pointerId),e.preventDefault()}),v.addEventListener("pointermove",u),v.addEventListener("pointerup",g),v.addEventListener("pointercancel",g),window.addEventListener("resize",()=>{var e=v.getBoundingClientRect(),t=Math.max(8,window.innerWidth-v.offsetWidth-8),a=Math.max(8,window.innerHeight-v.offsetHeight-8),t=Math.min(Math.max(e.left,8),t),e=Math.min(Math.max(e.top,8),a);v.style.left=t+"px",v.style.top=e+"px",F.panelX=t,F.panelY=e,O(["panelX","panelY"])}),c.addEventListener("click",e=>{d?(e.preventDefault(),e.stopPropagation()):(F.isPanelCollapsed=!F.isPanelCollapsed,O(["isPanelCollapsed"]),D())})}}D()}function s(){q.isStale=!0,q.meta.textContent=q.meta.textContent.replace(/ \| Status: .+$/,"")+" | Status: pending recalculation"}function d(){U(),q.isStale=!1,X(),A(),ie()}}function f(){return F.overlays.find(e=>e.id===F.activeOverlayId)||null}function ee(){var i=document.getElementById("op-overlay-list");if(i){i.innerHTML="";for(let r of F.overlays){var l=document.createElement("div"),n=(l.className="op-item"+(r.id===F.activeOverlayId?" active":""),r.isLocal?" (local)":r.imageBase64?"":" (no image)");l.innerHTML=`
        <input type="radio" name="op-active" ${r.id===F.activeOverlayId?"checked":""} title="Set active"/>
        <input type="checkbox" ${r.enabled?"checked":""} title="Toggle enabled"/>
        <div class="op-item-name" title="${(r.name||"(unnamed)")+n}">${(r.name||"(unnamed)")+n}</div>
        <button class="op-icon-btn" title="Delete overlay">🗑️</button>
      `;let[e,t,a,o]=l.children;e.addEventListener("change",()=>{F.activeOverlayId=r.id,O(["activeOverlayId"]),D()}),t.addEventListener("change",()=>{r.enabled=t.checked,O(["overlays"]),R(),P()}),a.addEventListener("click",()=>{F.activeOverlayId=r.id,O(["activeOverlayId"]),D()}),o.addEventListener("click",async e=>{e.stopPropagation(),confirm(`Delete overlay "${r.name||"(unnamed)"}"?`)&&0<=(e=F.overlays.findIndex(e=>e.id===r.id))&&(F.overlays.splice(e,1),F.activeOverlayId===r.id&&(F.activeOverlayId=F.overlays[0]?.id||null),await O(["overlays","activeOverlayId"]),R(),P(),D())}),i.appendChild(l)}}}async function te(e,t){var o;t&&t.type&&t.type.startsWith("image/")?confirm("Local PNGs cannot be exported to friends! Are you sure?")&&(o=t,t=await new Promise((e,t)=>{let a=new FileReader;a.onload=()=>e(a.result),a.onerror=t,a.readAsDataURL(o)}),e.imageBase64=t,e.imageUrl=null,e.isLocal=!0,await O(["overlays"]),R(),F.autoCapturePixelUrl=!0,await O(["autoCapturePixelUrl"]),P(),D(),B("Local image loaded. Placement mode ON -- click once to set anchor.")):alert("Please choose an image file.")}function ae(e){return navigator.clipboard&&navigator.clipboard.writeText?navigator.clipboard.writeText(e):Promise.reject(new Error("Clipboard API not available"))}function oe(){document.body.classList.toggle("op-theme-dark","dark"===F.theme),document.body.classList.toggle("op-theme-light","dark"!==F.theme);var e=document.getElementById("op-toast-stack");e&&e.classList.toggle("op-dark","dark"===F.theme)}async function D(){var e,t,a,o,r,i,l=e=>document.getElementById(e),n=l("overlay-pro-panel");n&&(oe(),a=l("op-content"),i=l("op-panel-toggle"),l("op-header"),t=!!F.isPanelCollapsed,n.classList.toggle("collapsed",t),a.style.display=t?"none":"grid",i.classList.toggle("logo-button",t),i.title=t?"Expand":"Collapse",(n=l("op-mode-select"))&&(n.value=F.overlayMode),a=l("op-autocap-toggle"),i=l("op-place-label"),a.textContent=F.autoCapturePixelUrl?"ON":"OFF",a.classList.toggle("op-danger",!!F.autoCapturePixelUrl),i.classList.toggle("op-danger-text",!!F.autoCapturePixelUrl),(t=l("op-highlight-toggle"))&&(t.checked=!!F.highlightPixels),n=l("op-list-wrap"),a=l("op-collapse-list"),n.style.display=F.collapseList?"none":"block",a&&(a.textContent=F.collapseList?"▸":"▾"),i=l("op-nudge-body"),t=l("op-collapse-nudge"),i.style.display=F.collapseNudge?"none":"block",t&&(t.textContent=F.collapseNudge?"▸":"▾"),n=l("op-colors-body"),a=l("op-collapse-colors"),n&&(n.style.display=F.collapseColors?"none":"block"),a&&(a.textContent=F.collapseColors?"▸":"▾"),ee(),i=e=>document.getElementById(e),t=f(),n=i("op-editor-section"),a=i("op-editor-body"),n.style.display=t?"flex":"none",t&&(i("op-name").value=t.name||"",n=i("op-image-source"),e=i("op-preview-wrap"),r=i("op-image-preview"),o=i("op-cc-btn-row"),t.imageBase64?(n.style.display="none",e.style.display="flex",r.src=t.imageBase64,o.style.display="flex"):(n.style.display="block",e.style.display="none",o.style.display="none",i("op-image-url").value=t.imageUrl||""),r=t.pixelUrl?k(t.pixelUrl):{chunk1:"-",chunk2:"-",posX:"-",posY:"-"},i("op-coord-display").textContent=t.pixelUrl?`Ref: chunk ${r.chunk1}/${r.chunk2} at (${r.posX}, ${r.posY})`:'No pixel anchor set. Turn ON "Place overlay" and click a pixel once.',i("op-opacity-slider").value=String(t.opacity),i("op-opacity-value").textContent=Math.round(100*t.opacity)+"%",(n=document.getElementById("op-offset-indicator"))&&(n.textContent=`Offset X ${t.offsetX}, Y `+t.offsetY),a.style.display=F.collapseEditor?"none":"block",e=document.getElementById("op-collapse-editor"))&&(e.textContent=F.collapseEditor?"▸":"▾"),await z(),o=l("op-export-overlay"),i=!(!(r=f())||!r.imageUrl||r.isLocal),o.disabled=!i,o.title=i?"Export active overlay JSON":"Export disabled for local images")}let g=new Map;async function N(e){if(!e||!e.imageBase64)return{};var t=e.imageBase64.slice(0,64)+":"+e.imageBase64.length;if(g.has(t))return g.get(t);var a,e=await E(e.imageBase64),o=L(e.width,e.height).getContext("2d",{willReadFrequently:!0}),o=(o.drawImage(e,0,0),o.getImageData(0,0,e.width,e.height)),r=o.data,i={};for(let e=0;e<r.length;e+=4)0<r[e+3]&&(i[a=`${r[e]},${r[e+1]},`+r[e+2]]=(i[a]||0)+1);return g.set(t,i),i}async function z(){var t=f(),a=document.getElementById("op-colors-section");if(a)if(t&&t.imageBase64){a.style.display="flex";var o=document.getElementById("op-colors-list"),r=(o.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">Loading...</div>',await N(t)),i=await(async a=>{if(!a||!a.imageBase64||!a.pixelUrl)return null;var e=Q(a),t=Array.from(I.keys()).sort().join(";"),e=a.id+`|${e}|`+t;if($.has(e))return $.get(e);var o=(t=await E(a.imageBase64)).width,r=t.height,i=L(o,r).getContext("2d",{willReadFrequently:!0}),l=(i.drawImage(t,0,0),(t=i.getImageData(0,0,o,r)).data),n=k(a.pixelUrl);if(!Number.isFinite(n.chunk1)||!Number.isFinite(n.chunk2))return null;var s={};for(let t=0;t<r;t++)for(let e=0;e<o;e++){var d,p,c,u,v,g,m,h,f=4*(t*o+e);0!==l[3+f]&&(s[c=(d=l[f])+`,${p=l[1+f]},`+(f=l[2+f])]||(s[c]={smart:0,below:0}),m=n.chunk1*w+n.posX+a.offsetX+e,v=n.chunk2*w+n.posY+a.offsetY+t,g=Math.floor(m/w)+","+Math.floor(v/w),I.has(g))&&(u=(g=I.get(g)).data,g=g.width,m=(m%w+w)%w,g=u[v=4*((v%w+w)%w*g+m)],m=u[1+v],h=u[2+v],0===u[3+v]?s[c].below++:d===g&&p===m&&f===h||s[c].smart++)}return $.set(e,s),s})(t)||{};let e;e=null==t.visibleColorKeys?new Set(Object.keys(r)):new Set(t.visibleColorKeys);var t=Object.entries(r).sort(([,e],[,t])=>t-e),l=new Set(m.map(([e,t,a])=>e+`,${t},`+a));if(o.innerHTML="",0===t.length)o.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">No colors found.</div>';else{for(var[n,s]of t){var d=l.has(n),p=h[n]||n,c=document.createElement("div"),d=(c.className="op-dist-item"+(d?" premium":""),c.title=`${p} (${n}): ${s} pixels`,i[n]?.below||0),d=`<span style="color: cyan;">${d}</span>/<span style="color: red;">${i[n]?.smart||0}</span>/`+s;c.innerHTML=`
            <input type="checkbox" data-key="${n}" ${e.has(n)?"checked":""} style="margin-right: 4px;">
            <div class="op-color-list-swatch" style="background-color: rgb(${n});"></div>
            <div class="op-color-list-name">${p}</div>
            <div class="op-color-list-count">${d}</div>
        `,o.appendChild(c)}o.querySelectorAll('input[type="checkbox"]').forEach(o=>{o.addEventListener("change",async()=>{var e,t=o.dataset.key,a=f();a&&(null===a.visibleColorKeys&&(e=Object.keys(await N(a)),a.visibleColorKeys=e),e=new Set(a.visibleColorKeys),o.checked?e.add(t):e.delete(t),a.visibleColorKeys=Array.from(e),await O(["overlays"]),R())})})}}else a.style.display="none"}let q=null;function Y(){q&&(q.backdrop.classList.remove("show"),q.modal.style.display="none",q.overlay=null,document.body.classList.remove("op-scroll-lock"))}function re(){let o=[];return q.selectedFree.forEach(e=>{var[e,t,a]=e.split(",").map(e=>parseInt(e,10));Number.isFinite(e)&&o.push([e,t,a])}),q.selectedPaid.forEach(e=>{var[e,t,a]=e.split(",").map(e=>parseInt(e,10));Number.isFinite(e)&&o.push([e,t,a])}),o}function U(){if(q.sourceImageData){var e=q.sourceImageData.width,t=q.sourceImageData.height,a=q.sourceImageData.data,o=new Uint8ClampedArray(a.length),r=re(),i={};for(let e=0;e<a.length;e+=4){var l=a[e],n=a[e+1],s=a[e+2];0===a[e+3]?(o[e]=0,o[e+1]=0,o[e+2]=0,o[e+3]=0):([l,n,s]=r.length?((t,a,o,r)=>{let i=null,l=1/0;for(let e=0;e<r.length;e++){var[n,s,d]=r[e],p=(n+t)/2,c=n-t,u=s-a,v=d-o,c=((512+p)*c*c>>8)+4*u*u+((767-p)*v*v>>8);c<l&&(l=c,i=[n,s,d])}return i||[0,0,0]})(l,n,s,r):[l,n,s],o[e]=l,o[e+1]=n,o[e+2]=s,o[e+3]=255,i[l=l+`,${n},`+s]=(i[l]||0)+1)}q.processedCanvas||(q.processedCanvas=document.createElement("canvas"),q.processedCtx=q.processedCanvas.getContext("2d")),q.processedCanvas.width=e,q.processedCanvas.height=t;e=new ImageData(o,e,t);q.processedCtx.putImageData(e,0,0),q.lastColorCounts=i}}function X(){var e,t,a=Number(q.zoom)||1,o=q.processedCanvas;o&&(e=Math.max(1,Math.round(o.width*a)),a=Math.max(1,Math.round(o.height*a)),q.previewCanvas.width=e,q.previewCanvas.height=a,(t=q.previewCtx).clearRect(0,0,e,a),t.imageSmoothingEnabled=!1,t.drawImage(o,0,0,o.width,o.height,0,0,e,a),t.imageSmoothingEnabled=!0)}function A(){var e,t,a,o;q.sourceImageData?(e=q.sourceImageData.width,t=q.sourceImageData.height,a=Object.keys(q.lastColorCounts||{}).length,o=q.isStale?"pending recalculation":"up to date",q.meta.textContent=`Size: ${e}×${t} | Zoom: ${q.zoom.toFixed(2)}× | Colors: ${a} | Status: `+o):q.meta.textContent=""}function ie(){if(q&&q.lastColorCounts){var e=document.getElementById("op-cc-color-list");if(e){var t=q.lastColorCounts,t=Object.entries(t).sort(([,e],[,t])=>t-e),a=new Set(m.map(([e,t,a])=>e+`,${t},`+a));if(e.innerHTML="",0===t.length)e.innerHTML='<div class="op-muted" style="text-align:center; padding: 12px 0;">No colors in image.</div>';else for(var[o,r]of t){var i=a.has(o),l=h[o]||o,n=document.createElement("div");n.className="op-color-list-item"+(i?" premium":""),n.title=`${l} (${o}): ${r} pixels`,n.innerHTML=`
        <div class="op-color-list-swatch" style="background-color: rgb(${o});"></div>
        <div class="op-color-list-name">${l}</div>
        <div class="op-color-list-count">${r}</div>
      `,e.appendChild(n)}}}}function W(){q.freeToggle.textContent=le()?"Unselect All":"Select All",q.paidToggle.textContent=ne()?"Unselect All":"Select All"}function le(){return o.every(e=>q.selectedFree.has(e))}function ne(){var e=m.map(([e,t,a])=>e+`,${t},`+a);return e.every(e=>q.selectedPaid.has(e))&&0<e.length}function se(e,t){"free"===e?(e=o,t?e.forEach(e=>q.selectedFree.add(e)):q.selectedFree.clear(),q.freeGrid.querySelectorAll(".op-cc-cell").forEach(e=>e.classList.toggle("active",t))):(e=m.map(([e,t,a])=>e+`,${t},`+a),t?e.forEach(e=>q.selectedPaid.add(e)):q.selectedPaid.clear(),q.paidGrid.querySelectorAll(".op-cc-cell").forEach(e=>e.classList.toggle("active",t)))}let H=null;function de(){H&&(window.removeEventListener("resize",H._resizeHandler||(()=>{})),H.backdrop.classList.remove("show"),H.modal.style.display="none",H.ov=null,H.img=null,document.body.classList.remove("op-scroll-lock"))}(async()=>{try{await Promise.all(u.map(async e=>{F[e]=await t(e,F[e])})),Array.isArray(F.ccFreeKeys)&&0!==F.ccFreeKeys.length||(F.ccFreeKeys=o.slice()),Array.isArray(F.ccPaidKeys)||(F.ccPaidKeys=s.slice()),(!Number.isFinite(F.ccZoom)||F.ccZoom<=0)&&(F.ccZoom=1),"boolean"!=typeof F.ccRealtime&&(F.ccRealtime=!1)}catch(e){console.error("Hail's OP: Failed to load config",e)}})().then(()=>{P();var e=()=>{var e;(e=document.createElement("style")).textContent=`
      body.op-theme-light {
        --op-bg: #f7f9fc;
        --op-border: #e1e8f2;
        --op-muted: #6b7280;
        --op-text: #1f2937;
        --op-subtle: #ffffff;
        --op-btn: #ffffff;
        --op-btn-border: #d1d9e6;
        --op-btn-hover: #f0f3f8;
        --op-accent: #2563eb;
      }
      body.op-theme-dark {
        --op-bg: #111827;
        --op-border: #374151;
        --op-muted: #9ca3af;
        --op-text: #f3f4f6;
        --op-subtle: #1f2937;
        --op-btn: #374151;
        --op-btn-border: #4b5563;
        --op-btn-hover: #4b5563;
        --op-accent: #3b82f6;
      }
      .op-scroll-lock { overflow: hidden !important; }

      #overlay-pro-panel {
        position: fixed; z-index: 9999; background: var(--op-bg); border: 1px solid var(--op-border);
        border-radius: 12px; color: var(--op-text); font-family: Inter, system-ui, -apple-system, Segoe UI, Roboto, Helvetica, Arial, "Apple Color Emoji", "Segoe UI Emoji";
        font-size: 14px; width: auto; box-shadow: 0 8px 16px rgba(0,0,0,0.1); user-select: none;
      }
      #overlay-pro-panel.collapsed {
        width: auto;
        background: transparent;
        border: none;
        box-shadow: none;
      }

      .op-header { display: flex; align-items: center; justify-content: space-between; padding: 10px 12px; border-bottom: 1px solid var(--op-border); border-radius: 12px 12px 0 0; cursor: grab; }
      .op-header:active { cursor: grabbing; }
      .op-header h3 { margin: 0; font-size: 15px; font-weight: 600; }
      .op-header-actions { display: flex; gap: 6px; }
      #overlay-pro-panel.collapsed .op-header h3,
      #overlay-pro-panel.collapsed .op-header #op-theme-toggle,
      #overlay-pro-panel.collapsed .op-header #op-refresh-btn {
        display: none;
      }
      #overlay-pro-panel.collapsed .op-header {
        border-bottom: none;
        padding: 0;
        cursor: default;
      }
      #overlay-pro-panel.collapsed .op-header .op-header-actions {
        justify-content: flex-end;
        width: 100%;
      }
      .op-toggle-btn, .op-hdr-btn { background: var(--op-btn); border: 1px solid var(--op-btn-border); color: var(--op-text); border-radius: 8px; padding: 4px 8px; cursor: pointer; }
      .op-toggle-btn:hover, .op-hdr-btn:hover { background: var(--op-btn); }
      #op-panel-toggle.logo-button {
          background-image: url("data:image/svg+xml,%3csvg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 24 24' fill='none' stroke='%232563eb' stroke-width='2' stroke-linecap='round' stroke-linejoin='round'%3e%3cpath d='M12 2.69l5.66 5.66a8 8 0 1 1-11.32 0L12 2.69z'/%3e%3c/svg%3e");
          background-color: var(--op-bg);
          background-size: 24px 24px;
          background-repeat: no-repeat;
          background-position: center;
          width: 42px;
          height: 42px;
          border: 1px solid var(--op-border);
          border-radius: 50%;
          text-indent: -9999px;
          box-shadow: 0 2px 8px rgba(0,0,0,0.1);
          transition: all 0.2s ease-in-out;
          cursor: grab;
      }
      #op-panel-toggle.logo-button:hover {
          transform: scale(1.1);
          box-shadow: 0 6px 16px rgba(0,0,0,0.15);
      }

      .op-content { padding: 12px; display: grid; grid-template-columns: 1fr 320px; gap: 12px; }
      .op-section { display: flex; flex-direction: column; gap: 8px; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; padding: 8px; }

      .op-section-title { display: flex; align-items: center; justify-content: space-between; }
      .op-title-text { font-weight: 600; }
      .op-chevron { background: var(--op-btn); border: 1px solid var(--op-btn-border); border-radius: 6px; padding: 2px 6px; cursor: pointer; }
      .op-chevron:hover { background: var(--op-btn); }

      .op-row { display: flex; align-items: center; gap: 8px; }
      .op-row.space { justify-content: space-between; }

      .op-button { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 8px; padding: 6px 10px; cursor: pointer; }
      .op-button:hover { background: var(--op-btn-hover); }
      .op-button:disabled { opacity: 0.5; cursor: not-allowed; }
      .op-button.icon { width: 30px; height: 30px; padding: 0; display: inline-flex; align-items: center; justify-content: center; font-size: 16px; }

      .op-input, .op-select { background: var(--op-bg); border: 1px solid var(--op-border); color: var(--op-text); border-radius: 8px; padding: 6px 8px; }
      .op-slider { width: 100%; }

      .op-list { display: flex; flex-direction: column; gap: 6px; max-height: 140px; overflow: auto; border: 1px solid var(--op-border); padding: 6px; border-radius: 8px; background: var(--op-bg); }

      .op-item { display: flex; align-items: center; gap: 6px; padding: 6px; border-radius: 8px; border: 1px solid var(--op-border); background: var(--op-subtle); }
      .op-item.active { outline: 2px solid color-mix(in oklab, var(--op-accent) 35%, transparent); background: var(--op-bg); }
      .op-item-name { flex: 1; overflow: hidden; text-overflow: ellipsis; white-space: nowrap; }

      .op-muted { color: var(--op-muted); font-size: 12px; }

      .op-preview { width: 100%; height: 90px; background: var(--op-bg); display: flex; align-items: center; justify-content: center; border: 2px dashed var(--op-border); border-radius: 8px; overflow: hidden; position: relative; cursor: pointer; }
      .op-preview img { max-width: 100%; max-height: 100%; display: block; pointer-events: none; }
      .op-preview.drop-highlight { background: color-mix(in oklab, var(--op-accent) 12%, transparent); }
      .op-preview .op-drop-hint { position: absolute; bottom: 6px; right: 8px; font-size: 11px; color: var(--op-muted); pointer-events: none; }

      .op-icon-btn { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 8px; width: 34px; height: 34px; display: inline-flex; align-items: center; justify-content: center; cursor: pointer; }
      .op-icon-btn:hover { background: var(--op-btn-hover); }

      .op-danger { background: #fee2e2; border-color: #fecaca; color: #7f1d1d; }
      .op-danger-text { color: #dc2626; font-weight: 600; }

      .op-toast-stack { position: fixed; top: 12px; left: 50%; transform: translateX(-50%); display: flex; flex-direction: column; align-items: center; gap: 8px; pointer-events: none; z-index: 999999; width: min(92vw, 480px); }
      .op-toast { background: var(--op-bg); border: 1px solid var(--op-border); color: var(--op-text); padding: 8px 16px; border-radius: 8px; font-size: 13px; box-shadow: 0 4px 12px rgba(0,0,0,0.1); opacity: 0; transform: translateY(-8px); transition: opacity .2s ease, transform .2s ease; max-width: 100%; text-align: center; }
      .op-toast.show { opacity: 1; transform: translateY(0); }
      .op-toast-stack.op-dark .op-toast { background: var(--op-bg); border-color: var(--op-border); color: var(--op-text); }

      /* Color Match Modal */
      .op-cc-backdrop { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.45); display: none; }
      .op-cc-backdrop.show { display: block; }

      .op-cc-modal {
        position: fixed; z-index: 10001;
        width: min(1280px, 98vw);
        max-height: 92vh;
        left: 50%; top: 50%; transform: translate(-50%, -50%);
        background: var(--op-bg); color: var(--op-text);
        border: 1px solid var(--op-border);
        border-radius: 14px;
        box-shadow: 0 16px 48px rgba(0,0,0,0.28);
        display: none; flex-direction: column;
      }
      .op-cc-header { padding: 10px 12px; border-bottom: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; user-select: none; cursor: default; }
      .op-cc-title { font-weight: 600; }
      .op-cc-close { border: 1px solid var(--op-btn-border); background: var(--op-btn); border-radius: 8px; padding: 4px 8px; cursor: pointer; }
      .op-cc-close:hover { background: var(--op-btn); }
      .op-cc-pill { border-radius: 999px; padding: 4px 10px; border: 1px solid var(--op-border); background: var(--op-bg); }

      .op-cc-body {
        display: grid;
        grid-template-columns: 2fr 420px;
        grid-template-areas: "preview controls";
        gap: 12px;
        padding: 12px;
        overflow: hidden;
      }
      @media (max-width: 860px) {
        .op-cc-body { grid-template-columns: 1fr; grid-template-areas: "preview" "controls"; max-height: calc(92vh - 100px); overflow: auto; }
      }

      .op-cc-preview-wrap { grid-area: preview; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; position: relative; min-height: 320px; display: flex; align-items: center; justify-content: center; overflow: auto; }
      .op-cc-canvas { image-rendering: pixelated; }
      .op-cc-zoom { position: absolute; top: 8px; right: 8px; display: inline-flex; gap: 6px; }
      .op-cc-zoom .op-icon-btn { width: 34px; height: 34px; }

      .op-cc-controls { grid-area: controls; display: flex; flex-direction: column; gap: 12px; background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 10px; padding: 10px; overflow: auto; max-height: calc(92vh - 160px); }
      .op-cc-block { display: flex; flex-direction: column; gap: 6px; }
      .op-cc-block label { color: var(--op-muted); font-weight: 600; }

      .op-cc-palette { display: flex; flex-direction: column; gap: 8px; background: var(--op-bg); border: 1px solid var(--op-border); border-radius: 8px; padding: 8px; }
      .op-list-subtle { background: var(--op-bg); border: 1px solid var(--op-border); border-radius: 8px; padding: 6px; }
      .op-cc-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(22px, 22px)); gap: 6px; }
      .op-cc-cell { width: 22px; height: 22px; border-radius: 4px; border: 2px solid #fff; box-shadow: 0 0 0 1px rgba(0,0,0,0.15) inset; cursor: pointer; }
      .op-cc-cell.active { outline: 2px solid var(--op-accent); }

      .op-cc-footer { padding: 10px 12px; border-top: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
      .op-cc-actions { display: inline-flex; gap: 8px; }
      .op-cc-ghost { color: var(--op-muted); font-size: 12px; }

      .op-color-list-item { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 2px 4px; }
      .op-color-list-swatch { width: 14px; height: 14px; border-radius: 4px; border: 1px solid var(--op-border); flex-shrink: 0; }
      .op-color-list-name { flex: 1; white-space: nowrap; overflow: hidden; text-overflow: ellipsis; }
      .op-color-list-count { font-weight: 600; }
      .op-color-list-item.premium .op-color-list-name { color: #eeff00ff; font-weight: bold; }
      .op-theme-dark .op-color-list-item.premium .op-color-list-name { color: #fdd835; }

      .op-dist-item { display: flex; align-items: center; gap: 8px; font-size: 12px; padding: 2px 4px; }
      .op-dist-item.premium .op-color-list-name { color: #eeff00ff; font-weight: bold; }
      .op-theme-dark .op-dist-item.premium .op-color-list-name { color: #fdd835; }

      /* Resize Modal */
      .op-rs-backdrop { position: fixed; inset: 0; z-index: 10000; background: rgba(0,0,0,0.45); display: none; }
      .op-rs-backdrop.show { display: block; }

      .op-rs-modal {
        position: fixed; z-index: 10001;
        width: min(1200px, 96vw);
        left: 50%; top: 50%; transform: translate(-50%, -50%);
        background: var(--op-bg); color: var(--op-text);
        border: 1px solid var(--op-border);
        border-radius: 12px;
        box-shadow: 0 12px 24px rgba(0,0,0,0.2);
        display: none; flex-direction: column;
        max-height: 92vh;
      }
      .op-rs-header { padding: 10px 12px; border-bottom: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; user-select: none; cursor: default; }
      .op-rs-title { font-weight: 600; }
      .op-rs-close { border: 1px solid var(--op-border); background: transparent; border-radius: 8px; padding: 4px 8px; cursor: pointer; }
      .op-rs-close:hover { background: var(--op-btn); }

      .op-rs-tabs { display: flex; gap: 6px; padding: 8px 12px 0 12px; }
      .op-rs-tab-btn { background: var(--op-btn); color: var(--op-text); border: 1px solid var(--op-btn-border); border-radius: 10px; padding: 6px 10px; cursor: pointer; }
      .op-rs-tab-btn.active { outline: 2px solid color-mix(in oklab, var(--op-accent) 35%, transparent); background: var(--op-btn-hover); }

      .op-rs-body { padding: 12px; display: grid; grid-template-columns: 1fr; gap: 10px; overflow: auto; }
      .op-rs-row { display: flex; align-items: center; gap: 8px; }
      .op-rs-row .op-input { flex: 1; }

      .op-rs-pane { display: none; }
      .op-rs-pane.show { display: block; }

      .op-rs-preview-wrap { background: var(--op-subtle); border: 1px solid var(--op-border); border-radius: 12px; position: relative; height: clamp(260px, 36vh, 540px); display: flex; align-items: center; justify-content: center; overflow: hidden; }
      .op-rs-canvas { image-rendering: pixelated; }

      .op-rs-zoom { position: absolute; top: 8px; right: 8px; display: inline-flex; gap: 6px; }

      .op-rs-grid-note { color: var(--op-muted); font-size: 12px; }
      .op-rs-mini { width: 96px; }

      .op-rs-dual { display: grid; grid-template-columns: 1fr 1fr; gap: 8px; width: 100%; height: 100%; padding: 8px; box-sizing: border-box; }
      .op-rs-col { position: relative; background: var(--op-bg); border: 1px dashed var(--op-border); border-radius: 10px; display: flex; flex-direction: column; align-items: center; justify-content: flex-start; overflow: hidden; }
      .op-rs-col .label { position: absolute; top: 2px; left: 0; right: 0; text-align: center; font-size: 12px; color: var(--op-muted); pointer-events: none; }
      .op-rs-col .pad-top { height: 18px; width: 100%; flex: 0 0 auto; }
      .op-rs-thumb { width: 100%; height: calc(100% - 18px); display: block; }

      .op-pan-grab { cursor: grab; }
      .op-pan-grabbing { cursor: grabbing; }

      .op-rs-footer { padding: 10px 12px; border-top: 1px solid var(--op-border); display: flex; align-items: center; justify-content: space-between; gap: 8px; flex-wrap: wrap; }
    `,document.head.appendChild(e),v(),oe()};"loading"===document.readyState?window.addEventListener("DOMContentLoaded",e):e(),console.log("Hail's OP: Initialized with Minify (fixed 3×) mode.")})})();